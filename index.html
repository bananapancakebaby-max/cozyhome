<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cozy Farm World</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { overflow: hidden; background: #d4e4d0; font-family: 'Segoe UI', sans-serif; }
  canvas { display: block; }

  /* LOGIN */
  #login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #d4e4d0; z-index: 200;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  #login-box {
    background: rgba(45,65,45,0.92); backdrop-filter: blur(12px);
    border-radius: 20px; padding: 40px 36px; text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-width: 300px;
  }
  #login-box h1 { color: #7ecd6a; font-size: 24px; margin-bottom: 4px; }
  #login-box p { color: #c8d8c4; font-size: 13px; margin-bottom: 24px; }
  #login-box .farm-emoji { font-size: 48px; margin-bottom: 16px; display: block; }
  #name-input {
    width: 100%; background: rgba(255,255,255,0.08); border: 2px solid rgba(126,205,106,0.3);
    border-radius: 12px; padding: 12px 16px; color: #e8f0e4; font-size: 14px; outline: none;
    text-align: center; margin-bottom: 16px;
  }
  #name-input:focus { border-color: #7ecd6a; }
  #name-input::placeholder { color: rgba(200,216,196,0.4); }
  #join-btn {
    width: 100%; background: #7ecd6a; border: none; border-radius: 12px;
    padding: 12px; color: #2d412d; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: background 0.2s;
  }
  #join-btn:hover { background: #6bba58; }

  /* GAME UI */
  #game-ui { display: none; }
  #ui-overlay { position: fixed; top: 16px; left: 16px; z-index: 10; }
  #player-badge {
    background: rgba(45,65,45,0.85); backdrop-filter: blur(8px);
    color: #e8f0e4; padding: 8px 16px; border-radius: 20px; font-size: 13px;
    display: flex; align-items: center; gap: 8px;
  }
  #player-badge .dot { width: 8px; height: 8px; background: #7ecd6a; border-radius: 50%; animation: pulse 2s infinite; }
  #controls-hint { position: fixed; top: 16px; right: 16px; z-index: 10; display: flex; flex-direction: column; gap: 6px; }
  .hint-pill { background: rgba(45,65,45,0.7); backdrop-filter: blur(8px); color: #e8f0e4; padding: 6px 14px; border-radius: 16px; font-size: 12px; text-align: right; }
  #chat-box { position: fixed; bottom: 16px; right: 16px; width: 280px; z-index: 10; background: rgba(45,65,45,0.88); backdrop-filter: blur(10px); border-radius: 14px; overflow: hidden; }
  #chat-header { padding: 10px 14px; font-size: 12px; font-weight: 600; color: #7ecd6a; letter-spacing: 1.5px; text-transform: uppercase; border-bottom: 1px solid rgba(126,205,106,0.15); }
  #chat-messages { height: 120px; padding: 10px 14px; overflow-y: auto; font-size: 12px; color: #c8d8c4; }
  #chat-input-row { display: flex; padding: 8px; gap: 6px; border-top: 1px solid rgba(126,205,106,0.15); }
  #chat-input { flex: 1; background: rgba(255,255,255,0.08); border: none; border-radius: 10px; padding: 8px 12px; color: #e8f0e4; font-size: 12px; outline: none; }
  #chat-input::placeholder { color: rgba(200,216,196,0.4); }
  #chat-send { background: #7ecd6a; border: none; border-radius: 10px; width: 34px; height: 34px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  #chat-send:hover { background: #6bba58; }
  #chat-send svg { width: 16px; height: 16px; fill: #2d412d; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  #click-indicator { position: fixed; pointer-events: none; z-index: 5; width: 20px; height: 20px; border: 2px solid rgba(126,205,106,0.6); border-radius: 50%; transform: translate(-50%,-50%) scale(0); opacity: 0; }
  #click-indicator.active { animation: clickRing 0.6s ease-out forwards; }
  @keyframes clickRing { 0%{transform:translate(-50%,-50%) scale(0);opacity:1} 100%{transform:translate(-50%,-50%) scale(2.5);opacity:0} }
  #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d4e4d0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
  #loading.done { opacity: 0; pointer-events: none; }
  #loading-text { color: #4a6a40; font-size: 16px; margin-top: 16px; }
  #loading-bar-bg { width: 200px; height: 6px; background: rgba(74,106,64,0.2); border-radius: 3px; margin-top: 10px; }
  #loading-bar { height: 100%; width: 0%; background: #7ecd6a; border-radius: 3px; transition: width 0.3s; }

  #bottom-buttons { position: fixed; bottom: 16px; left: 16px; z-index: 10; display: flex; gap: 8px; }
  .action-btn {
    background: rgba(45,65,45,0.88); backdrop-filter: blur(10px);
    color: #e8f0e4; border: none; border-radius: 14px; padding: 10px 18px;
    font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: background 0.2s; border: 2px solid transparent;
  }
  .action-btn:hover { background: rgba(55,80,55,0.92); }
  .action-btn.active { border-color: #e85a5a; background: rgba(80,45,45,0.88); }
  .action-btn .key-hint { background: rgba(255,255,255,0.1); padding: 2px 7px; border-radius: 6px; font-size: 11px; font-weight: 400; }

  #build-panel {
    position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
    width: 320px; z-index: 20;
    background: rgba(45,65,45,0.92); backdrop-filter: blur(12px);
    border-radius: 16px; overflow: hidden; display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }
  #build-panel.open { display: block; }
  #build-panel-header {
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(126,205,106,0.15);
  }
  #build-panel-header span { font-size: 12px; font-weight: 600; color: #7ecd6a; letter-spacing: 1.5px; text-transform: uppercase; }
  #build-close {
    background: rgba(255,255,255,0.08); border: none; color: #c8d8c4; font-size: 16px;
    width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  #build-close:hover { background: rgba(255,255,255,0.15); }
  #build-items { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }
  .build-slot {
    background: rgba(255,255,255,0.06); border: 2px solid transparent; border-radius: 12px;
    padding: 14px 10px; text-align: center; cursor: pointer; transition: border-color 0.15s, background 0.15s;
  }
  .build-slot:hover { background: rgba(255,255,255,0.1); border-color: rgba(126,205,106,0.3); }
  .build-slot.selected { border-color: #7ecd6a; background: rgba(126,205,106,0.12); }
  .build-slot .slot-icon { font-size: 28px; display: block; margin-bottom: 6px; }
  .build-slot .slot-label { font-size: 12px; color: #e8f0e4; font-weight: 500; }

  #placement-hint {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15;
    background: rgba(45,65,45,0.9); backdrop-filter: blur(8px);
    color: #c8d8c4; padding: 8px 18px; border-radius: 20px; font-size: 12px;
    display: none; white-space: nowrap;
  }
  #placement-hint.visible { display: block; }
  #demolish-hint {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15;
    background: rgba(80,45,45,0.9); backdrop-filter: blur(8px);
    color: #f0c8c8; padding: 8px 18px; border-radius: 20px; font-size: 12px;
    display: none; white-space: nowrap;
  }
</style>
</head>
<body>

<div id="login-screen">
  <div id="login-box">
    <span class="farm-emoji">üåøüè†üêë</span>
    <h1>Cozy Farm World</h1>
    <p>Enter your name to join the farm!</p>
    <input type="text" id="name-input" placeholder="Your name..." maxlength="12" />
    <button id="join-btn">Join Farm üåæ</button>
  </div>
</div>

<div id="loading" style="display:none;">
  <div id="loading-text">Loading farm... üåø</div>
  <div id="loading-bar-bg"><div id="loading-bar"></div></div>
</div>

<div id="game-ui">
  <div id="ui-overlay"><div id="player-badge"><span class="dot"></span><span>ONLINE ¬∑ <strong id="player-count">1 Player</strong></span></div></div>
  <div id="controls-hint">
    <div class="hint-pill">üñ± Click ground to move</div>
    <div class="hint-pill">‚Üî Drag to rotate camera</div>
    <div class="hint-pill">üîç Scroll to zoom</div>
  </div>
  <div id="chat-box">
    <div id="chat-header">üí¨ FARM CHAT</div>
    <div id="chat-messages"><div style="opacity:0.5;font-style:italic;">Welcome to the farm! üåø</div></div>
    <div id="chat-input-row">
      <input type="text" id="chat-input" placeholder="Type a message..." />
      <button id="chat-send"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
  </div>
  <div id="bottom-buttons">
    <button class="action-btn" id="build-btn">üî® Build <span class="key-hint">B</span></button>
    <button class="action-btn" id="demolish-btn">üöß Demolish <span class="key-hint">X</span></button>
  </div>
  <div id="build-panel">
    <div id="build-panel-header">
      <span>üî® BUILD / BUY</span>
      <button id="build-close">&times;</button>
    </div>
    <div id="build-items">
      <div class="build-slot" data-item="tree"><span class="slot-icon">üå≤</span><span class="slot-label">Tree</span></div>
      <div class="build-slot" data-item="grass"><span class="slot-icon">üåø</span><span class="slot-label">Grass Tuft</span></div>
      <div class="build-slot" data-item="flower"><span class="slot-icon">üå∏</span><span class="slot-label">Flower</span></div>
      <div class="build-slot" data-item="fence"><span class="slot-icon">ü™µ</span><span class="slot-label">Fence Post</span></div>
    </div>
  </div>
  <div id="placement-hint">Click ground to place ¬∑ Right-click or Esc to cancel</div>
  <div id="demolish-hint">Click a placed object to remove it ¬∑ Right-click or Esc to cancel</div>
</div>
<div id="click-indicator"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
try {

// ============ FIREBASE ============
firebase.initializeApp({
  apiKey: "AIzaSyDQBhG1cwh6ToxTcdiwC_ZE5yM2noDZk-M",
  authDomain: "cozyhome-a5122.firebaseapp.com",
  databaseURL: "https://cozyhome-a5122-default-rtdb.firebaseio.com",
  projectId: "cozyhome-a5122",
  storageBucket: "cozyhome-a5122.firebasestorage.app",
  messagingSenderId: "199992457269",
  appId: "1:199992457269:web:be0a5080576f78d0cb597c"
});
const db = firebase.database();
let localPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
let localPlayerName = '';

// ============ LOGIN ============
const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');
nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') startGame(); });
joinBtn.addEventListener('click', startGame);

function startGame() {
  localPlayerName = nameInput.value.trim();
  if (!localPlayerName) return;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('game-ui').style.display = 'block';
  initGame();
}

// ============ THREE.JS SCENE ============
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xd4e4d0);
scene.fog = new THREE.FogExp2(0xd4e4d0, 0.012);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 200);
camera.position.set(14, 14, 14);
camera.lookAt(0,0,0);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.prepend(renderer.domElement);

// Lighting
scene.add(new THREE.AmbientLight(0xfff5e6, 0.6));
const dl = new THREE.DirectionalLight(0xfff0d4, 0.9);
dl.position.set(10,20,8); dl.castShadow = true;
dl.shadow.mapSize.set(1024,1024);
dl.shadow.camera.near=0.5; dl.shadow.camera.far=60;
dl.shadow.camera.left=-20; dl.shadow.camera.right=20;
dl.shadow.camera.top=20; dl.shadow.camera.bottom=-20;
dl.shadow.bias=-0.001;
scene.add(dl);
scene.add(new THREE.DirectionalLight(0xc8e0ff, 0.3)).position.set(-8,10,-6);

// Ground
const gg = new THREE.Group();
const gt = new THREE.Mesh(new THREE.BoxGeometry(12,0.3,12), new THREE.MeshLambertMaterial({color:0xa8d89a}));
gt.receiveShadow=true; gg.add(gt);
const ge = new THREE.Mesh(new THREE.BoxGeometry(12.02,0.15,12.02), new THREE.MeshLambertMaterial({color:0x6b8c52}));
ge.position.y=-0.2; gg.add(ge);
const gd = new THREE.Mesh(new THREE.BoxGeometry(12,1.0,12), new THREE.MeshLambertMaterial({color:0xb07040}));
gd.position.y=-0.75; gd.castShadow=true; gg.add(gd);
const gb = new THREE.Mesh(new THREE.BoxGeometry(12,0.25,12), new THREE.MeshLambertMaterial({color:0x8b5530}));
gb.position.y=-1.4; gg.add(gb);
scene.add(gg);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(12,12), new THREE.MeshBasicMaterial({visible:false}));
ground.rotation.x=-Math.PI/2; ground.position.y=0.15; scene.add(ground);

// Grass tufts
for(let i=0;i<15;i++){
  const t=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.3,0.15),new THREE.MeshLambertMaterial({color:0x8cc47a}));
  t.position.set((Math.random()-0.5)*10,0.25,(Math.random()-0.5)*10); t.castShadow=true; scene.add(t);
}

// Farmhouse
function mkHouse(x,z){
  const g=new THREE.Group();
  const b=new THREE.Mesh(new THREE.BoxGeometry(4,3,3.5),new THREE.MeshLambertMaterial({color:0xe8675a}));
  b.position.y=1.5;b.castShadow=true;b.receiveShadow=true;g.add(b);
  const r=new THREE.Mesh(new THREE.ConeGeometry(3.2,2,4),new THREE.MeshLambertMaterial({color:0x6b3040}));
  r.position.y=4;r.rotation.y=Math.PI/4;r.castShadow=true;g.add(r);
  const d=new THREE.Mesh(new THREE.BoxGeometry(0.9,1.6,0.1),new THREE.MeshLambertMaterial({color:0x3d1f1f}));
  d.position.set(0,0.8,1.76);g.add(d);
  const wm=new THREE.MeshLambertMaterial({color:0xfff4b8});
  const wg=new THREE.BoxGeometry(0.7,0.7,0.1);
  g.add(new THREE.Mesh(wg,wm)).position.set(-1.2,2,1.76);
  g.add(new THREE.Mesh(wg,wm)).position.set(1.2,2,1.76);
  const c=new THREE.Mesh(new THREE.BoxGeometry(0.6,1.5,0.6),new THREE.MeshLambertMaterial({color:0x8b6050}));
  c.position.set(1.2,4.5,-0.5);c.castShadow=true;g.add(c);
  g.position.set(x,0,z);scene.add(g);
}
mkHouse(1,-1);

// Fallback trees
function mkPine(x,z,s){
  const g=new THREE.Group();
  const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.15*s,0.25*s,1.5*s,6),new THREE.MeshLambertMaterial({color:0x8b6848}));
  tr.position.y=0.75*s;tr.castShadow=true;g.add(tr);
  [[0x5a9e4b,1.8,1.8],[0x4d8b40,1.3,2.8],[0x3f7a35,0.8,3.6]].forEach(([c,sz,h])=>{
    const f=new THREE.Mesh(new THREE.ConeGeometry(sz*s*0.6,1.4*s,6),new THREE.MeshLambertMaterial({color:c}));
    f.position.y=h*s;f.castShadow=true;g.add(f);
  });
  g.position.set(x,0,z);scene.add(g);return g;
}
function mkRound(x,z,s){
  const g=new THREE.Group();
  const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.12*s,0.2*s,1.8*s,6),new THREE.MeshLambertMaterial({color:0x9b7858}));
  tr.position.y=0.9*s;tr.castShadow=true;g.add(tr);
  const cr=new THREE.Mesh(new THREE.SphereGeometry(1.2*s,8,6),new THREE.MeshLambertMaterial({color:0x6db85a}));
  cr.position.y=2.6*s;cr.castShadow=true;g.add(cr);
  g.position.set(x,0,z);scene.add(g);return g;
}

// GLB Trees
const TREE_URL = 'assets/stylized_pine_tree_tree.glb';
const loadBar = document.getElementById('loading-bar');
let loadedTreeModel = null;
const gltfLoader = new THREE.GLTFLoader();
gltfLoader.load(TREE_URL,
  (gltf) => {
    const m = gltf.scene;
    m.traverse(c => { if(c.isMesh){c.castShadow=true;c.receiveShadow=true;} });
    loadedTreeModel = m;
    [{x:-4,z:-3,s:0.02},{x:-3,z:3,s:0.015},{x:4,z:3,s:0.018}].forEach(t => {
      const tree = m.clone(); tree.position.set(t.x,0.15,t.z); tree.scale.setScalar(t.s); scene.add(tree);
    });
    loadBar.style.width='100%';
    setTimeout(()=>document.getElementById('loading').classList.add('done'),300);
  },
  (p)=>{if(p.total)loadBar.style.width=(p.loaded/p.total*100)+'%';},
  ()=>{mkPine(-4,-3,0.02);mkPine(-3,3,0.015);mkRound(4,3,0.018);loadBar.style.width='100%';setTimeout(()=>document.getElementById('loading').classList.add('done'),300);}
);

// Flowers
for(let i=0;i<5;i++){
  const fg=new THREE.Group();
  fg.add(new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.4,4),new THREE.MeshLambertMaterial({color:0x6aaa55}))).position.y=0.2;
  const cs=[0xf5a0b0,0xf0d060,0xffffff,0xc8a0f0];
  fg.add(new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),new THREE.MeshLambertMaterial({color:cs[Math.floor(Math.random()*4)]}))).position.y=0.45;
  const a=Math.random()*Math.PI*2,dd=2+Math.random()*3;
  fg.position.set(Math.cos(a)*dd,0,Math.sin(a)*dd);scene.add(fg);
}

// Fence
const fm=new THREE.MeshLambertMaterial({color:0xc4a46a});
[[-1,2],[1,2],[3,2],[3,0]].forEach(([x,z])=>{
  const p=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.8,0.15),fm);
  p.position.set(x,0.4,z);p.castShadow=true;scene.add(p);
});
const rm=new THREE.MeshLambertMaterial({color:0xb89858});
[[[-1,2],[1,2]],[[1,2],[3,2]],[[3,2],[3,0]]].forEach(([[x1,z1],[x2,z2]])=>{
  const dx=x2-x1,dz=z2-z1,len=Math.sqrt(dx*dx+dz*dz);
  const r=new THREE.Mesh(new THREE.BoxGeometry(len,0.08,0.08),rm);
  r.position.set((x1+x2)/2,0.55,(z1+z2)/2);r.rotation.y=Math.atan2(dz,dx);scene.add(r);
});

// ============ SHEEP ============
function createSheep(name, woolColor) {
  const sheep = new THREE.Group();
  const sb = new THREE.Mesh(new THREE.SphereGeometry(0.55,8,6), new THREE.MeshLambertMaterial({color:woolColor}));
  sb.position.y=0.7; sb.scale.set(1.1,0.9,0.85); sb.castShadow=true; sheep.add(sb);
  sheep.bodyMesh = sb;
  const sh = new THREE.Mesh(new THREE.SphereGeometry(0.3,8,6), new THREE.MeshLambertMaterial({color:0x3d3530}));
  sh.position.set(0,0.9,0.5); sh.castShadow=true; sheep.add(sh);
  [[-0.12,0.95,0.72],[0.12,0.95,0.72]].forEach(p=>{
    sheep.add(new THREE.Mesh(new THREE.SphereGeometry(0.06,6,4),new THREE.MeshLambertMaterial({color:0xffffff}))).position.set(...p);
  });
  [[-0.12,0.95,0.77],[0.12,0.95,0.77]].forEach(p=>{
    sheep.add(new THREE.Mesh(new THREE.SphereGeometry(0.035,6,4),new THREE.MeshLambertMaterial({color:0x1a1a1a}))).position.set(...p);
  });
  const sheepLegs=[];
  const lg=new THREE.CylinderGeometry(0.07,0.07,0.4,5),lm=new THREE.MeshLambertMaterial({color:0x3d3530});
  [[-0.25,0.2,0.2],[0.25,0.2,0.2],[-0.25,0.2,-0.2],[0.25,0.2,-0.2]].forEach(p=>{
    const l=new THREE.Mesh(lg,lm);l.position.set(...p);l.castShadow=true;sheep.add(l);sheepLegs.push(l);
  });
  sheep.legs = sheepLegs;
  const nc=document.createElement('canvas');nc.width=128;nc.height=32;
  const nx=nc.getContext('2d');
  nx.fillStyle='rgba(45,65,45,0.85)';nx.beginPath();nx.roundRect(0,0,128,32,8);nx.fill();
  nx.fillStyle='#e8f0e4';nx.font='bold 16px sans-serif';nx.textAlign='center';
  nx.fillText(name.toUpperCase(),64,22);
  const nt=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(nc),transparent:true}));
  nt.scale.set(1.5,0.4,1);nt.position.y=1.6;sheep.add(nt);
  const shadow=new THREE.Mesh(new THREE.CircleGeometry(0.5,16),new THREE.MeshBasicMaterial({color:0,transparent:true,opacity:0.12}));
  shadow.rotation.x=-Math.PI/2;shadow.position.y=0.01;
  sheep.shadowMesh=shadow;
  return sheep;
}

// ============ STATE ============
let player, playerShadow, legs;
const remotePlayers = {};
let placedObjects = [];
const placedObjectsMap = {};

// ============ BUILD / DEMOLISH ============
let selectedBuildItem = null;
let demolishMode = false;

function placeTree(x,z){
  let obj;
  if(loadedTreeModel){obj=loadedTreeModel.clone();obj.position.set(x,0.15,z);obj.scale.setScalar(0.02);scene.add(obj);}
  else{obj=mkPine(x,z,0.02);}
  return obj;
}
function placeGrassTuft(x,z){
  const m=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.3,0.15),new THREE.MeshLambertMaterial({color:0x8cc47a}));
  m.position.set(x,0.25,z);m.castShadow=true;scene.add(m);return m;
}
function placeFlower(x,z){
  const fg=new THREE.Group();
  fg.add(new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.4,4),new THREE.MeshLambertMaterial({color:0x6aaa55}))).position.y=0.2;
  const cs=[0xf5a0b0,0xf0d060,0xffffff,0xc8a0f0];
  fg.add(new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),new THREE.MeshLambertMaterial({color:cs[Math.floor(Math.random()*4)]}))).position.y=0.45;
  fg.position.set(x,0,z);scene.add(fg);return fg;
}
function placeFencePost(x,z){
  const m=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.8,0.15),new THREE.MeshLambertMaterial({color:0xc4a46a}));
  m.position.set(x,0.4,z);m.castShadow=true;scene.add(m);return m;
}

const buildFactories = {tree:placeTree, grass:placeGrassTuft, flower:placeFlower, fence:placeFencePost};

function updateBuildUI(){
  document.querySelectorAll('.build-slot').forEach(s=>s.classList.toggle('selected',s.dataset.item===selectedBuildItem));
  document.getElementById('placement-hint').classList.toggle('visible',selectedBuildItem!==null);
  document.getElementById('demolish-hint').style.display=demolishMode?'block':'none';
  document.getElementById('demolish-btn').classList.toggle('active',demolishMode);
}
function cancelBuild(){selectedBuildItem=null;demolishMode=false;updateBuildUI();}
function toggleDemolish(){
  if(demolishMode){cancelBuild();return;}
  selectedBuildItem=null;buildPanel.classList.remove('open');demolishMode=true;updateBuildUI();
}

const buildPanel=document.getElementById('build-panel');
document.getElementById('build-btn').addEventListener('click',()=>{
  demolishMode=false;buildPanel.classList.toggle('open');
  if(!buildPanel.classList.contains('open'))cancelBuild();updateBuildUI();
});
document.getElementById('demolish-btn').addEventListener('click',toggleDemolish);
document.getElementById('build-close').addEventListener('click',()=>{buildPanel.classList.remove('open');cancelBuild();});
document.querySelectorAll('.build-slot').forEach(slot=>{
  slot.addEventListener('click',()=>{selectedBuildItem=slot.dataset.item;demolishMode=false;updateBuildUI();buildPanel.classList.remove('open');});
});
addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='b'||e.key==='B'){demolishMode=false;buildPanel.classList.toggle('open');if(!buildPanel.classList.contains('open'))cancelBuild();updateBuildUI();}
  if(e.key==='x'||e.key==='X'){toggleDemolish();}
  if(e.key==='Escape'){buildPanel.classList.remove('open');cancelBuild();}
});
renderer.domElement.addEventListener('contextmenu',e=>{e.preventDefault();cancelBuild();});

// ============ MOVEMENT ============
let targetPos=new THREE.Vector3(0,0,2),isMoving=false;
const ray=new THREE.Raycaster(),mss=new THREE.Vector2();

renderer.domElement.addEventListener('click',e=>{
  if(isDrag)return;
  mss.x=(e.clientX/innerWidth)*2-1;mss.y=-(e.clientY/innerHeight)*2+1;
  ray.setFromCamera(mss,camera);

  if(demolishMode){
    let allMeshes=[];
    placedObjects.forEach(obj=>{
      if(obj.isMesh){allMeshes.push({mesh:obj,root:obj});}
      else{obj.traverse(child=>{if(child.isMesh)allMeshes.push({mesh:child,root:obj});});}
    });
    const hits=ray.intersectObjects(allMeshes.map(m=>m.mesh),false);
    if(hits.length){
      const entry=allMeshes.find(m=>m.mesh===hits[0].object);
      if(entry){
        let fbKey=null;
        for(const[key,obj]of Object.entries(placedObjectsMap)){if(obj===entry.root){fbKey=key;break;}}
        if(fbKey)db.ref('objects/'+fbKey).remove();
      }
    }
    return;
  }

  const h=ray.intersectObject(ground);
  if(h.length){
    if(selectedBuildItem){
      const pt=h[0].point;
      db.ref('objects').push({type:selectedBuildItem,x:pt.x,z:pt.z,placedBy:localPlayerId});
      cancelBuild();return;
    }
    targetPos.copy(h[0].point);targetPos.y=0;isMoving=true;
    const ind=document.getElementById('click-indicator');
    ind.style.left=e.clientX+'px';ind.style.top=e.clientY+'px';
    ind.classList.remove('active');void ind.offsetWidth;ind.classList.add('active');
  }
});

// ============ CAMERA ============
let isDrag=false,pmx=0,pmy=0,camA=Math.PI/4,camP=0.5,camD=14;
renderer.domElement.addEventListener('mousedown',e=>{isDrag=false;pmx=e.clientX;pmy=e.clientY;});
renderer.domElement.addEventListener('mousemove',e=>{
  if(e.buttons!==1)return;
  const dx=e.clientX-pmx,dy=e.clientY-pmy;
  if(Math.abs(dx)>3||Math.abs(dy)>3)isDrag=true;
  camA-=dx*0.005;camP=Math.max(0.2,Math.min(1.2,camP+dy*0.005));
  pmx=e.clientX;pmy=e.clientY;
});
renderer.domElement.addEventListener('wheel',e=>{camD=Math.max(6,Math.min(22,camD+e.deltaY*0.02));});
renderer.domElement.addEventListener('touchstart',e=>{if(e.touches.length===1){pmx=e.touches[0].clientX;pmy=e.touches[0].clientY;isDrag=false;}});
renderer.domElement.addEventListener('touchmove',e=>{
  if(e.touches.length===1){
    const dx=e.touches[0].clientX-pmx,dy=e.touches[0].clientY-pmy;
    if(Math.abs(dx)>3||Math.abs(dy)>3)isDrag=true;
    camA-=dx*0.005;camP=Math.max(0.2,Math.min(1.2,camP+dy*0.005));
    pmx=e.touches[0].clientX;pmy=e.touches[0].clientY;
  }
  e.preventDefault();
},{passive:false});

// ============ CHAT ============
const ci=document.getElementById('chat-input'),cm=document.getElementById('chat-messages');
function sendMsg(){
  const m=ci.value.trim();if(!m)return;
  db.ref('chat').push({name:localPlayerName,text:m,time:Date.now()});
  ci.value='';
}
document.getElementById('chat-send').addEventListener('click',sendMsg);
ci.addEventListener('keydown',e=>{if(e.key==='Enter')sendMsg();});
function escapeHTML(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ============ INIT GAME ============
function initGame(){
  player=createSheep(localPlayerName,0xf5f0e8);
  player.position.set(0,0,2);scene.add(player);
  legs=player.legs;
  playerShadow=player.shadowMesh;
  playerShadow.position.set(0,0.16,2);scene.add(playerShadow);

  const playerRef=db.ref('players/'+localPlayerId);
  playerRef.set({name:localPlayerName,x:0,z:2,rot:0});
  playerRef.onDisconnect().remove();

  // Players
  db.ref('players').on('child_added',snap=>{
    const id=snap.key;if(id===localPlayerId)return;
    const data=snap.val();
    const colors=[0xd4c4b0,0xc4d4e0,0xe0c4d4,0xd4e0c4,0xe0d4b0];
    const ci2=Math.abs(id.split('').reduce((a,c)=>a+c.charCodeAt(0),0))%colors.length;
    const remote=createSheep(data.name,colors[ci2]);
    remote.position.set(data.x,0,data.z);scene.add(remote);
    const rs=remote.shadowMesh;rs.position.set(data.x,0.16,data.z);scene.add(rs);
    remotePlayers[id]={group:remote,shadow:rs,targetX:data.x,targetZ:data.z,targetRot:data.rot||0,legs:remote.legs,bodyMesh:remote.bodyMesh};
    updatePlayerCount();
  });
  db.ref('players').on('child_changed',snap=>{
    const id=snap.key;if(id===localPlayerId)return;const data=snap.val();
    if(remotePlayers[id]){remotePlayers[id].targetX=data.x;remotePlayers[id].targetZ=data.z;remotePlayers[id].targetRot=data.rot||0;}
  });
  db.ref('players').on('child_removed',snap=>{
    const id=snap.key;
    if(remotePlayers[id]){scene.remove(remotePlayers[id].group);scene.remove(remotePlayers[id].shadow);delete remotePlayers[id];updatePlayerCount();}
  });

  // Chat
  db.ref('chat').orderByChild('time').limitToLast(50).on('child_added',snap=>{
    const data=snap.val();const d=document.createElement('div');d.style.marginTop='6px';
    const color=data.name===localPlayerName?'#7ecd6a':'#6ab8e0';
    d.innerHTML='<span style="color:'+color+';font-weight:600;">'+escapeHTML(data.name)+':</span> '+escapeHTML(data.text);
    cm.appendChild(d);cm.scrollTop=cm.scrollHeight;
  });

  // Objects
  db.ref('objects').on('child_added',snap=>{
    const data=snap.val(),key=snap.key;
    if(buildFactories[data.type]){const obj=buildFactories[data.type](data.x,data.z);placedObjects.push(obj);placedObjectsMap[key]=obj;}
  });
  db.ref('objects').on('child_removed',snap=>{
    const key=snap.key;
    if(placedObjectsMap[key]){scene.remove(placedObjectsMap[key]);const idx=placedObjects.indexOf(placedObjectsMap[key]);if(idx>-1)placedObjects.splice(idx,1);delete placedObjectsMap[key];}
  });

  animate();
}

function updatePlayerCount(){
  const count=1+Object.keys(remotePlayers).length;
  document.getElementById('player-count').textContent=count+(count===1?' Player':' Players');
}

// ============ SYNC ============
let lastSyncTime=0;
function syncPosition(){
  const now=Date.now();if(now-lastSyncTime<100)return;lastSyncTime=now;
  db.ref('players/'+localPlayerId).update({x:player.position.x,z:player.position.z,rot:player.rotation.y});
}

// ============ ANIMATE ============
let t=0;
function animate(){
  requestAnimationFrame(animate);t+=0.016;
  if(isMoving){
    const dx=targetPos.x-player.position.x,dz=targetPos.z-player.position.z;
    if(Math.sqrt(dx*dx+dz*dz)>0.1){
      player.position.x+=dx*0.06;player.position.z+=dz*0.06;
      player.rotation.y=Math.atan2(dx,dz);
      player.position.y=Math.abs(Math.sin(t*8))*0.08;
      legs.forEach((l,i)=>l.rotation.x=Math.sin(t*10+i*Math.PI)*0.3);
      syncPosition();
    }else{isMoving=false;player.position.y=0;legs.forEach(l=>l.rotation.x=0);syncPosition();}
  }else{if(player)player.bodyMesh.scale.y=0.9+Math.sin(t*2)*0.02;}
  if(playerShadow){playerShadow.position.x=player.position.x;playerShadow.position.z=player.position.z;}

  for(const id in remotePlayers){
    const rp=remotePlayers[id],g=rp.group;
    const dx=rp.targetX-g.position.x,dz=rp.targetZ-g.position.z;
    if(Math.sqrt(dx*dx+dz*dz)>0.05){
      g.position.x+=dx*0.08;g.position.z+=dz*0.08;
      g.position.y=Math.abs(Math.sin(t*8))*0.08;
      rp.legs.forEach((l,i)=>l.rotation.x=Math.sin(t*10+i*Math.PI)*0.3);
    }else{g.position.y=0;rp.legs.forEach(l=>l.rotation.x=0);rp.bodyMesh.scale.y=0.9+Math.sin(t*2)*0.02;}
    g.rotation.y+=(rp.targetRot-g.rotation.y)*0.1;
    rp.shadow.position.x=g.position.x;rp.shadow.position.z=g.position.z;
  }

  if(player){
    const cx=player.position.x+Math.sin(camA)*camD*Math.cos(camP);
    const cy=Math.sin(camP)*camD;
    const cz=player.position.z+Math.cos(camA)*camD*Math.cos(camP);
    camera.position.lerp(new THREE.Vector3(cx,cy,cz),0.05);
    camera.lookAt(new THREE.Vector3(player.position.x,1,player.position.z));
  }
  renderer.render(scene,camera);
}

addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

} catch(err) {
  const errDiv = document.createElement('div');
  errDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;border-radius:10px;z-index:9999;max-width:80%;font-size:14px;white-space:pre-wrap;';
  errDiv.textContent = 'ERROR: ' + err.message + '\n\n' + err.stack;
  document.body.appendChild(errDiv);
}
</script>
</body>
</html>

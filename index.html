<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cozy Farm World</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { overflow: hidden; background: #d4e4d0; font-family: 'Segoe UI', sans-serif; }
  canvas { display: block; }

  /* ===== LOGIN SCREEN ===== */
  #login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #d4e4d0; z-index: 200;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  #login-box {
    background: rgba(45,65,45,0.92); backdrop-filter: blur(12px);
    border-radius: 20px; padding: 40px 36px; text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); min-width: 300px;
  }
  #login-box h1 { color: #7ecd6a; font-size: 24px; margin-bottom: 4px; }
  #login-box p { color: #c8d8c4; font-size: 13px; margin-bottom: 24px; }
  #login-box .farm-emoji { font-size: 48px; margin-bottom: 16px; display: block; }
  #name-input {
    width: 100%; background: rgba(255,255,255,0.08); border: 2px solid rgba(126,205,106,0.3);
    border-radius: 12px; padding: 12px 16px; color: #e8f0e4; font-size: 14px; outline: none;
    text-align: center; margin-bottom: 16px;
  }
  #name-input:focus { border-color: #7ecd6a; }
  #name-input::placeholder { color: rgba(200,216,196,0.4); }
  #join-btn {
    width: 100%; background: #7ecd6a; border: none; border-radius: 12px;
    padding: 12px; color: #2d412d; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: background 0.2s;
  }
  #join-btn:hover { background: #6bba58; }
  #join-btn:disabled { background: #5a8a50; cursor: not-allowed; opacity: 0.6; }

  /* ===== GAME UI ===== */
  #game-ui { display: none; }
  #ui-overlay { position: fixed; top: 16px; left: 16px; z-index: 10; }
  #player-badge {
    background: rgba(45, 65, 45, 0.85); backdrop-filter: blur(8px);
    color: #e8f0e4; padding: 8px 16px; border-radius: 20px; font-size: 13px;
    display: flex; align-items: center; gap: 8px;
  }
  #player-badge .dot { width: 8px; height: 8px; background: #7ecd6a; border-radius: 50%; animation: pulse 2s infinite; }
  #controls-hint { position: fixed; top: 16px; right: 16px; z-index: 10; display: flex; flex-direction: column; gap: 6px; }
  .hint-pill { background: rgba(45,65,45,0.7); backdrop-filter: blur(8px); color: #e8f0e4; padding: 6px 14px; border-radius: 16px; font-size: 12px; text-align: right; }
  #chat-box { position: fixed; bottom: 16px; right: 16px; width: 280px; z-index: 10; background: rgba(45,65,45,0.88); backdrop-filter: blur(10px); border-radius: 14px; overflow: hidden; }
  #chat-header { padding: 10px 14px; font-size: 12px; font-weight: 600; color: #7ecd6a; letter-spacing: 1.5px; text-transform: uppercase; border-bottom: 1px solid rgba(126,205,106,0.15); }
  #chat-messages { height: 120px; padding: 10px 14px; overflow-y: auto; font-size: 12px; color: #c8d8c4; }
  #chat-input-row { display: flex; padding: 8px; gap: 6px; border-top: 1px solid rgba(126,205,106,0.15); }
  #chat-input { flex: 1; background: rgba(255,255,255,0.08); border: none; border-radius: 10px; padding: 8px 12px; color: #e8f0e4; font-size: 12px; outline: none; }
  #chat-input::placeholder { color: rgba(200,216,196,0.4); }
  #chat-send { background: #7ecd6a; border: none; border-radius: 10px; width: 34px; height: 34px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  #chat-send:hover { background: #6bba58; }
  #chat-send svg { width: 16px; height: 16px; fill: #2d412d; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  #click-indicator { position: fixed; pointer-events: none; z-index: 5; width: 20px; height: 20px; border: 2px solid rgba(126,205,106,0.6); border-radius: 50%; transform: translate(-50%,-50%) scale(0); opacity: 0; }
  #click-indicator.active { animation: clickRing 0.6s ease-out forwards; }
  @keyframes clickRing { 0%{transform:translate(-50%,-50%) scale(0);opacity:1} 100%{transform:translate(-50%,-50%) scale(2.5);opacity:0} }
  #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d4e4d0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
  #loading.done { opacity: 0; pointer-events: none; }
  #loading-text { color: #4a6a40; font-size: 16px; margin-top: 16px; }
  #loading-bar-bg { width: 200px; height: 6px; background: rgba(74,106,64,0.2); border-radius: 3px; margin-top: 10px; }
  #loading-bar { height: 100%; width: 0%; background: #7ecd6a; border-radius: 3px; transition: width 0.3s; }

  #bottom-buttons { position: fixed; bottom: 16px; left: 16px; z-index: 10; display: flex; gap: 8px; }
  .action-btn {
    background: rgba(45,65,45,0.88); backdrop-filter: blur(10px);
    color: #e8f0e4; border: none; border-radius: 14px; padding: 10px 18px;
    font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: background 0.2s, border-color 0.2s; border: 2px solid transparent;
  }
  .action-btn:hover { background: rgba(55,80,55,0.92); }
  .action-btn.active { border-color: #e85a5a; background: rgba(80,45,45,0.88); }
  .action-btn.active-select { border-color: #6a9ae8; background: rgba(45,55,80,0.88); }
  .action-btn .key-hint { background: rgba(255,255,255,0.1); padding: 2px 7px; border-radius: 6px; font-size: 11px; font-weight: 400; }

  #build-panel {
    position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
    width: 320px; z-index: 20;
    background: rgba(45,65,45,0.92); backdrop-filter: blur(12px);
    border-radius: 16px; overflow: hidden; display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }
  #build-panel.open { display: block; }
  #build-panel-header {
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(126,205,106,0.15);
  }
  #build-panel-header span { font-size: 12px; font-weight: 600; color: #7ecd6a; letter-spacing: 1.5px; text-transform: uppercase; }
  #build-close {
    background: rgba(255,255,255,0.08); border: none; color: #c8d8c4; font-size: 16px;
    width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  #build-close:hover { background: rgba(255,255,255,0.15); }
  #build-items { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }
  .build-slot {
    background: rgba(255,255,255,0.06); border: 2px solid transparent; border-radius: 12px;
    padding: 14px 10px; text-align: center; cursor: pointer; transition: border-color 0.15s, background 0.15s;
  }
  .build-slot:hover { background: rgba(255,255,255,0.1); border-color: rgba(126,205,106,0.3); }
  .build-slot.selected { border-color: #7ecd6a; background: rgba(126,205,106,0.12); }
  .build-slot .slot-icon { font-size: 28px; display: block; margin-bottom: 6px; }
  .build-slot .slot-label { font-size: 12px; color: #e8f0e4; font-weight: 500; }

  #placement-hint {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15;
    background: rgba(45,65,45,0.9); backdrop-filter: blur(8px);
    color: #c8d8c4; padding: 8px 18px; border-radius: 20px; font-size: 12px;
    display: none; white-space: nowrap;
  }
  #placement-hint.visible { display: block; }
  #demolish-hint {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15;
    background: rgba(80,45,45,0.9); backdrop-filter: blur(8px);
    color: #f0c8c8; padding: 8px 18px; border-radius: 20px; font-size: 12px;
    display: none; white-space: nowrap;
  }
  #select-hint {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15;
    background: rgba(45,55,80,0.9); backdrop-filter: blur(8px);
    color: #c8d0f0; padding: 8px 18px; border-radius: 20px; font-size: 12px;
    display: none; white-space: nowrap;
  }

  /* Floating edit panel */
  #float-edit {
    position: fixed; z-index: 22; display: none;
    background: rgba(30,45,30,0.95); backdrop-filter: blur(12px);
    border-radius: 14px; padding: 14px 16px; min-width: 260px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.35); border: 1px solid rgba(126,205,106,0.2);
  }
  #float-edit.open { display: block; }
  #float-edit-title {
    font-size: 11px; font-weight: 700; color: #f0c06a; letter-spacing: 1px;
    text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
  }
  #float-edit-close {
    background: rgba(255,255,255,0.08); border: none; color: #c8d8c4; font-size: 14px;
    width: 22px; height: 22px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  #float-edit-close:hover { background: rgba(255,255,255,0.15); }
  .fedit-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
  .fedit-row label { color: #c8d8c4; font-size: 10px; font-weight: 500; min-width: 50px; }
  .fedit-slider { width: 120px; accent-color: #7ecd6a; cursor: pointer; }
  .fedit-val { color: #7ecd6a; font-size: 10px; font-weight: 600; min-width: 40px; text-align: right; }
  .fedit-btn {
    background: rgba(126,205,106,0.15); border: 1px solid rgba(126,205,106,0.3);
    color: #7ecd6a; padding: 6px 10px; border-radius: 8px; font-size: 11px;
    font-weight: 600; cursor: pointer; width: 100%; margin-top: 6px;
  }
  .fedit-btn:hover { background: rgba(126,205,106,0.25); }

  /* ===== ADMIN PANEL ===== */
  #admin-panel {
    position: fixed; top: 0; right: -360px; width: 350px; height: 100%;
    background: rgba(30,45,30,0.95); backdrop-filter: blur(14px);
    z-index: 25; transition: right 0.3s ease; overflow-y: auto;
    border-left: 1px solid rgba(126,205,106,0.2);
  }
  #admin-panel.open { right: 0; }
  #admin-panel-header {
    padding: 16px 18px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(126,205,106,0.2); position: sticky; top: 0;
    background: rgba(30,45,30,0.98); z-index: 1;
  }
  #admin-panel-header span { font-size: 13px; font-weight: 700; color: #f0c06a; letter-spacing: 1.5px; text-transform: uppercase; }
  #admin-panel-close {
    background: rgba(255,255,255,0.08); border: none; color: #c8d8c4; font-size: 18px;
    width: 30px; height: 30px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  #admin-panel-close:hover { background: rgba(255,255,255,0.15); }
  .admin-section {
    padding: 14px 18px; border-bottom: 1px solid rgba(126,205,106,0.1);
  }
  .admin-section-title {
    font-size: 11px; font-weight: 700; color: #f0c06a; letter-spacing: 1.2px;
    text-transform: uppercase; margin-bottom: 12px;
  }
  .admin-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .admin-row label {
    color: #c8d8c4; font-size: 12px; font-weight: 500;
  }
  .admin-slider {
    width: 140px; accent-color: #7ecd6a; cursor: pointer;
  }
  .admin-value {
    color: #7ecd6a; font-size: 11px; font-weight: 600; min-width: 36px; text-align: right;
  }
  .admin-color-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
  }
  .admin-color-row label {
    color: #c8d8c4; font-size: 12px; font-weight: 500; flex: 1;
  }
  .admin-color-input {
    width: 40px; height: 28px; border: 2px solid rgba(126,205,106,0.3);
    border-radius: 6px; cursor: pointer; background: none; padding: 0;
  }
  .admin-btn {
    background: rgba(126,205,106,0.15); border: 1px solid rgba(126,205,106,0.3);
    color: #7ecd6a; padding: 8px 14px; border-radius: 10px; font-size: 12px;
    font-weight: 600; cursor: pointer; transition: background 0.2s; width: 100%;
    margin-bottom: 6px;
  }
  .admin-btn:hover { background: rgba(126,205,106,0.25); }
  .admin-btn.danger {
    background: rgba(200,80,80,0.15); border-color: rgba(200,80,80,0.3); color: #e08a8a;
  }
  .admin-btn.danger:hover { background: rgba(200,80,80,0.25); }
  .admin-preset-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px;
  }
  .admin-preset {
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; padding: 8px; text-align: center; cursor: pointer;
    font-size: 11px; color: #c8d8c4; transition: all 0.15s;
  }
  .admin-preset:hover { background: rgba(255,255,255,0.12); border-color: #7ecd6a; }

  .admin-select {
    width: 100%; background: rgba(255,255,255,0.08); border: 1px solid rgba(126,205,106,0.3);
    border-radius: 8px; padding: 8px 10px; color: #e8f0e4; font-size: 12px; outline: none;
    margin-bottom: 10px; cursor: pointer;
  }
  .admin-select option { background: #2d412d; color: #e8f0e4; }
  .admin-code-box {
    background: rgba(0,0,0,0.3); border: 1px solid rgba(126,205,106,0.2);
    border-radius: 8px; padding: 10px; font-family: 'Courier New', monospace;
    font-size: 10px; color: #7ecd6a; word-break: break-all; max-height: 120px;
    overflow-y: auto; margin-top: 8px; display: none; user-select: all;
  }
  .admin-code-box.visible { display: block; }
  .admin-row-tight { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .admin-row-tight label { color: #c8d8c4; font-size: 11px; font-weight: 500; }
  .admin-slider-sm { width: 110px; accent-color: #7ecd6a; cursor: pointer; }
  .admin-value-sm { color: #7ecd6a; font-size: 10px; font-weight: 600; min-width: 44px; text-align: right; }
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div id="login-box">
    <span class="farm-emoji">üåøüè†üêë</span>
    <h1>Cozy Farm World</h1>
    <p>Enter your name to join the farm!</p>
    <input type="text" id="name-input" placeholder="Your name..." maxlength="12" />
    <button id="join-btn" disabled>Join Farm üåæ</button>
  </div>
</div>

<!-- ===== LOADING ===== -->
<div id="loading" style="display:none;">
  <div id="loading-text">Loading farm... üåø</div>
  <div id="loading-bar-bg"><div id="loading-bar"></div></div>
</div>

<!-- ===== GAME UI ===== -->
<div id="game-ui">
  <div id="ui-overlay"><div id="player-badge"><span class="dot"></span><span>ONLINE ¬∑ <strong id="player-count">1 Player</strong></span></div></div>
  <div id="controls-hint">
    <div class="hint-pill">üñ± Click ground to move</div>
    <div class="hint-pill">‚Üî Drag to rotate camera</div>
    <div class="hint-pill">üîç Scroll to zoom</div>
  </div>
  <div id="chat-box">
    <div id="chat-header">üí¨ FARM CHAT</div>
    <div id="chat-messages"><div style="opacity:0.5;font-style:italic;">Welcome to the farm! üåø</div></div>
    <div id="chat-input-row">
      <input type="text" id="chat-input" placeholder="Type a message..." />
      <button id="chat-send"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
  </div>
  <div id="bottom-buttons">
    <button class="action-btn" id="build-btn">üî® Build <span class="key-hint">B</span></button>
    <button class="action-btn" id="demolish-btn">üöß Demolish <span class="key-hint">X</span></button>
    <button class="action-btn" id="select-btn" style="border-color:rgba(100,140,220,0.4);color:#8ab0e8;">‚úã Select <span class="key-hint">V</span></button>
    <button class="action-btn" id="admin-btn" style="border-color:rgba(240,192,106,0.4);color:#f0c06a;">‚öôÔ∏è Admin</button>
  </div>
  <div id="build-panel">
    <div id="build-panel-header">
      <span>üî® BUILD / BUY</span>
      <button id="build-close">&times;</button>
    </div>
    <div id="build-items">
      <div class="build-slot" data-item="tree"><span class="slot-icon">üå≤</span><span class="slot-label">Tree</span></div>
      <div class="build-slot" data-item="grass"><span class="slot-icon">üåø</span><span class="slot-label">Grass Tuft</span></div>
      <div class="build-slot" data-item="flower"><span class="slot-icon">üå∏</span><span class="slot-label">Flower</span></div>
      <div class="build-slot" data-item="fence"><span class="slot-icon">ü™µ</span><span class="slot-label">Fence Post</span></div>
    </div>
  </div>
  <div id="placement-hint">Click ground to place ¬∑ Right-click or Esc to cancel</div>
  <div id="demolish-hint">Click a placed object to remove it ¬∑ Right-click or Esc to cancel</div>
  <div id="select-hint">Click any object to select & edit it ¬∑ Esc to cancel</div>
</div>

<!-- Floating edit panel -->
<div id="float-edit">
  <div id="float-edit-title"><span id="float-edit-name">Object</span><button id="float-edit-close">&times;</button></div>
  <div class="fedit-row"><label>Scale</label><input type="range" class="fedit-slider" id="fedit-scale" min="0.001" max="3" value="1" step="0.001"><span class="fedit-val" id="fedit-scale-val">1.000</span></div>
  <div class="fedit-row"><label>Pos X</label><input type="range" class="fedit-slider" id="fedit-x" min="-20" max="20" value="0" step="0.25"><span class="fedit-val" id="fedit-x-val">0.00</span></div>
  <div class="fedit-row"><label>Pos Y</label><input type="range" class="fedit-slider" id="fedit-y" min="-2" max="8" value="0" step="0.05"><span class="fedit-val" id="fedit-y-val">0.00</span></div>
  <div class="fedit-row"><label>Pos Z</label><input type="range" class="fedit-slider" id="fedit-z" min="-20" max="20" value="0" step="0.25"><span class="fedit-val" id="fedit-z-val">0.00</span></div>
  <div class="fedit-row"><label>Rotate Y</label><input type="range" class="fedit-slider" id="fedit-ry" min="0" max="6.28" value="0" step="0.05"><span class="fedit-val" id="fedit-ry-val">0.00</span></div>
  <button class="fedit-btn" id="fedit-save">üíæ Save to Server</button>
  <button class="fedit-btn" id="fedit-copy">üìã Copy Values</button>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="admin-panel">
  <div id="admin-panel-header">
    <span>‚öôÔ∏è ADMIN PANEL</span>
    <button id="admin-panel-close">&times;</button>
  </div>

  <!-- MAP SIZE -->
  <div class="admin-section">
    <div class="admin-section-title">üó∫Ô∏è Map Size</div>
    <div class="admin-row">
      <label>Ground Size</label>
      <input type="range" class="admin-slider" id="admin-map-size" min="8" max="40" value="12" step="2">
      <span class="admin-value" id="admin-map-size-val">12</span>
    </div>
  </div>

  <!-- FARMHOUSE -->
  <div class="admin-section">
    <div class="admin-section-title">üè† Farmhouse</div>
    <div class="admin-row">
      <label>Position X</label>
      <input type="range" class="admin-slider" id="admin-house-x" min="-15" max="15" value="1" step="0.5">
      <span class="admin-value" id="admin-house-x-val">1</span>
    </div>
    <div class="admin-row">
      <label>Position Z</label>
      <input type="range" class="admin-slider" id="admin-house-z" min="-15" max="15" value="-1" step="0.5">
      <span class="admin-value" id="admin-house-z-val">-1</span>
    </div>
    <div class="admin-row">
      <label>Scale</label>
      <input type="range" class="admin-slider" id="admin-house-scale" min="0.5" max="2" value="1" step="0.1">
      <span class="admin-value" id="admin-house-scale-val">1.0</span>
    </div>
    <button class="admin-btn danger" id="admin-house-toggle">Hide Farmhouse</button>
  </div>

  <!-- SKY & FOG -->
  <div class="admin-section">
    <div class="admin-section-title">üå§Ô∏è Sky & Atmosphere</div>
    <div class="admin-color-row">
      <label>Sky Color</label>
      <input type="color" class="admin-color-input" id="admin-sky-color" value="#d4e4d0">
    </div>
    <div class="admin-color-row">
      <label>Ground Color</label>
      <input type="color" class="admin-color-input" id="admin-ground-color" value="#a8d89a">
    </div>
    <div class="admin-color-row">
      <label>Light Warmth</label>
      <input type="color" class="admin-color-input" id="admin-light-color" value="#fff0d4">
    </div>
    <div class="admin-row">
      <label>Fog Density</label>
      <input type="range" class="admin-slider" id="admin-fog" min="0" max="0.04" value="0.012" step="0.002">
      <span class="admin-value" id="admin-fog-val">0.012</span>
    </div>
    <div class="admin-section-title" style="margin-top:10px;">üé® Presets</div>
    <div class="admin-preset-grid">
      <div class="admin-preset" data-preset="default">üåø Default</div>
      <div class="admin-preset" data-preset="sunset">üåÖ Sunset</div>
      <div class="admin-preset" data-preset="night">üåô Night</div>
      <div class="admin-preset" data-preset="winter">‚ùÑÔ∏è Winter</div>
      <div class="admin-preset" data-preset="cherry">üå∏ Cherry Blossom</div>
      <div class="admin-preset" data-preset="autumn">üçÇ Autumn</div>
    </div>
  </div>

  <!-- DECORATIONS -->
  <div class="admin-section">
    <div class="admin-section-title">ü™® Quick Decorations</div>
    <button class="admin-btn" id="admin-add-rocks">Add Rocks (5)</button>
    <button class="admin-btn" id="admin-add-path">Add Stone Path</button>
    <button class="admin-btn" id="admin-add-pond">Add Pond</button>
    <button class="admin-btn" id="admin-add-flowers">Add Flower Patch (8)</button>
    <button class="admin-btn danger" id="admin-clear-all" style="margin-top:8px;">Clear All Placed Objects</button>
  </div>

  <!-- ASSET EDITOR -->
  <div class="admin-section">
    <div class="admin-section-title">üì¶ Asset Editor</div>
    <p style="color:rgba(200,216,196,0.5);font-size:10px;margin-bottom:10px;">Import a GLB, tweak scale/position live, then copy the final values.</p>

    <label style="color:#c8d8c4;font-size:11px;display:block;margin-bottom:4px;">Select asset to edit:</label>
    <select class="admin-select" id="asset-select">
      <option value="tree">üå≤ Tree (stylized_pine_tree_tree.glb)</option>
      <option value="custom">üìÅ Load custom GLB from assets/...</option>
    </select>
    <div id="asset-custom-input" style="display:none;margin-bottom:10px;">
      <input type="text" id="asset-custom-path" placeholder="e.g. character.glb" style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(126,205,106,0.3);border-radius:8px;padding:8px 10px;color:#e8f0e4;font-size:12px;outline:none;">
      <button class="admin-btn" id="asset-custom-load" style="margin-top:6px;">Load GLB</button>
    </div>

    <button class="admin-btn" id="asset-spawn">Spawn Asset on Map</button>

    <div id="asset-editor-controls" style="display:none;margin-top:12px;">
      <div class="admin-section-title" style="color:#7ecd6a;">üéõÔ∏è Live Adjustments</div>

      <div class="admin-row-tight">
        <label>Scale</label>
        <input type="range" class="admin-slider-sm" id="asset-scale" min="0.001" max="0.2" value="0.02" step="0.001">
        <span class="admin-value-sm" id="asset-scale-val">0.020</span>
      </div>
      <div class="admin-row-tight">
        <label>Pos X</label>
        <input type="range" class="admin-slider-sm" id="asset-pos-x" min="-20" max="20" value="0" step="0.25">
        <span class="admin-value-sm" id="asset-pos-x-val">0.00</span>
      </div>
      <div class="admin-row-tight">
        <label>Pos Y</label>
        <input type="range" class="admin-slider-sm" id="asset-pos-y" min="-2" max="5" value="0.15" step="0.05">
        <span class="admin-value-sm" id="asset-pos-y-val">0.15</span>
      </div>
      <div class="admin-row-tight">
        <label>Pos Z</label>
        <input type="range" class="admin-slider-sm" id="asset-pos-z" min="-20" max="20" value="0" step="0.25">
        <span class="admin-value-sm" id="asset-pos-z-val">0.00</span>
      </div>
      <div class="admin-row-tight">
        <label>Rotation Y</label>
        <input type="range" class="admin-slider-sm" id="asset-rot-y" min="0" max="6.28" value="0" step="0.1">
        <span class="admin-value-sm" id="asset-rot-y-val">0.0</span>
      </div>

      <button class="admin-btn" id="asset-copy-values" style="margin-top:8px;">üìã Copy Values as Code</button>
      <button class="admin-btn danger" id="asset-remove">Remove Preview Asset</button>
      <div class="admin-code-box" id="asset-code-output"></div>
    </div>
  </div>

  <!-- SAVE -->
  <div class="admin-section">
    <div class="admin-section-title">üíæ Sync</div>
    <button class="admin-btn" id="admin-save">Save Map Settings to Server</button>
    <p style="color:rgba(200,216,196,0.5);font-size:10px;margin-top:6px;">Settings sync to Firebase so both players see the same map.</p>
  </div>
</div>

<div id="click-indicator"></div>

<!-- ===== SCRIPTS ===== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script>

// ============ FIREBASE SETUP ============
const firebaseConfig = {
  apiKey: "AIzaSyDQBhG1cwh6ToxTcdiwC_ZE5yM2noDZk-M",
  authDomain: "cozyhome-a5122.firebaseapp.com",
  databaseURL: "https://cozyhome-a5122-default-rtdb.firebaseio.com",
  projectId: "cozyhome-a5122",
  storageBucket: "cozyhome-a5122.firebasestorage.app",
  messagingSenderId: "199992457269",
  appId: "1:199992457269:web:be0a5080576f78d0cb597c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let localPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
let localPlayerName = '';

// ============ LOGIN ============
const nameInput = document.getElementById('name-input');
const joinBtn = document.getElementById('join-btn');
nameInput.addEventListener('input', () => { joinBtn.disabled = nameInput.value.trim().length === 0; });
nameInput.addEventListener('keydown', e => { if (e.key === 'Enter' && nameInput.value.trim()) startGame(); });
joinBtn.addEventListener('click', startGame);

function startGame() {
  localPlayerName = nameInput.value.trim();
  if (!localPlayerName) return;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('game-ui').style.display = 'block';
  initGame();
}

// ============ THREE.JS SCENE ============
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xd4e4d0);
scene.fog = new THREE.FogExp2(0xd4e4d0, 0.012);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 200);
camera.position.set(14, 14, 14);
camera.lookAt(0,0,0);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.prepend(renderer.domElement);

// Lighting
const ambLight = new THREE.AmbientLight(0xfff5e6, 0.6);
scene.add(ambLight);
const dl = new THREE.DirectionalLight(0xfff0d4, 0.9);
dl.position.set(10,20,8); dl.castShadow = true;
dl.shadow.mapSize.set(1024,1024);
dl.shadow.camera.near=0.5; dl.shadow.camera.far=60;
dl.shadow.camera.left=-20; dl.shadow.camera.right=20;
dl.shadow.camera.top=20; dl.shadow.camera.bottom=-20;
dl.shadow.bias=-0.001;
scene.add(dl);
const fl = new THREE.DirectionalLight(0xc8e0ff, 0.3);
fl.position.set(-8,10,-6); scene.add(fl);

// ============ GROUND (editable) ============
let mapSize = 12;
const gg = new THREE.Group();
let gtMesh, geMesh, gdMesh, gbMesh, groundPlane;

function buildGround(size) {
  // Remove old
  while(gg.children.length) gg.remove(gg.children[0]);
  if(groundPlane) scene.remove(groundPlane);

  gtMesh = new THREE.Mesh(new THREE.BoxGeometry(size,0.3,size), new THREE.MeshLambertMaterial({color:0xa8d89a}));
  gtMesh.receiveShadow=true; gg.add(gtMesh);
  geMesh = new THREE.Mesh(new THREE.BoxGeometry(size+0.02,0.15,size+0.02), new THREE.MeshLambertMaterial({color:0x6b8c52}));
  geMesh.position.y=-0.2; gg.add(geMesh);
  gdMesh = new THREE.Mesh(new THREE.BoxGeometry(size,1.0,size), new THREE.MeshLambertMaterial({color:0xb07040}));
  gdMesh.position.y=-0.75; gdMesh.castShadow=true; gg.add(gdMesh);
  gbMesh = new THREE.Mesh(new THREE.BoxGeometry(size,0.25,size), new THREE.MeshLambertMaterial({color:0x8b5530}));
  gbMesh.position.y=-1.4; gg.add(gbMesh);

  groundPlane = new THREE.Mesh(new THREE.PlaneGeometry(size,size), new THREE.MeshBasicMaterial({visible:false}));
  groundPlane.rotation.x=-Math.PI/2; groundPlane.position.y=0.15;
  scene.add(groundPlane);
  mapSize = size;
}
buildGround(12);
scene.add(gg);

// ============ FARMHOUSE (editable) ============
let farmhouse = null;
let farmhouseVisible = true;

function buildHouse(x, z, scale) {
  if(farmhouse) scene.remove(farmhouse);
  const g=new THREE.Group();
  const b=new THREE.Mesh(new THREE.BoxGeometry(4,3,3.5),new THREE.MeshLambertMaterial({color:0xe8675a}));
  b.position.y=1.5;b.castShadow=true;b.receiveShadow=true;g.add(b);
  const r=new THREE.Mesh(new THREE.ConeGeometry(3.2,2,4),new THREE.MeshLambertMaterial({color:0x6b3040}));
  r.position.y=4;r.rotation.y=Math.PI/4;r.castShadow=true;g.add(r);
  const d=new THREE.Mesh(new THREE.BoxGeometry(0.9,1.6,0.1),new THREE.MeshLambertMaterial({color:0x3d1f1f}));
  d.position.set(0,0.8,1.76);g.add(d);
  const wm=new THREE.MeshLambertMaterial({color:0xfff4b8});
  const wg=new THREE.BoxGeometry(0.7,0.7,0.1);
  const w1=new THREE.Mesh(wg,wm);w1.position.set(-1.2,2,1.76);g.add(w1);
  const w2=new THREE.Mesh(wg,wm);w2.position.set(1.2,2,1.76);g.add(w2);
  const c=new THREE.Mesh(new THREE.BoxGeometry(0.6,1.5,0.6),new THREE.MeshLambertMaterial({color:0x8b6050}));
  c.position.set(1.2,4.5,-0.5);c.castShadow=true;g.add(c);
  g.position.set(x,0,z);
  g.scale.setScalar(scale);
  scene.add(g);
  farmhouse = g;
  farmhouseVisible = true;
  // Register for select mode (remove old entry first)
  const idx = defaultObjects.findIndex(o => o.id === 'farmhouse');
  if (idx > -1) defaultObjects.splice(idx, 1);
  defaultObjects.push({obj: g, name: 'Farmhouse', id: 'farmhouse'});
}
buildHouse(1, -1, 1);

// Grass tufts
for(let i=0;i<15;i++){
  const tt=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.3,0.15),new THREE.MeshLambertMaterial({color:0x8cc47a}));
  tt.position.set((Math.random()-0.5)*10,0.25,(Math.random()-0.5)*10); tt.castShadow=true; scene.add(tt);
}

// Fallback trees
function mkPine(x,z,s){
  const g=new THREE.Group();
  const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.15*s,0.25*s,1.5*s,6),new THREE.MeshLambertMaterial({color:0x8b6848}));
  tr.position.y=0.75*s;tr.castShadow=true;g.add(tr);
  [[0x5a9e4b,1.8,1.8],[0x4d8b40,1.3,2.8],[0x3f7a35,0.8,3.6]].forEach(([c,sz,h])=>{
    const f=new THREE.Mesh(new THREE.ConeGeometry(sz*s*0.6,1.4*s,6),new THREE.MeshLambertMaterial({color:c}));
    f.position.y=h*s;f.castShadow=true;g.add(f);
  });
  g.position.set(x,0,z);scene.add(g);return g;
}
function mkRound(x,z,s){
  const g=new THREE.Group();
  const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.12*s,0.2*s,1.8*s,6),new THREE.MeshLambertMaterial({color:0x9b7858}));
  tr.position.y=0.9*s;tr.castShadow=true;g.add(tr);
  const cr=new THREE.Mesh(new THREE.SphereGeometry(1.2*s,8,6),new THREE.MeshLambertMaterial({color:0x6db85a}));
  cr.position.y=2.6*s;cr.castShadow=true;g.add(cr);
  g.position.set(x,0,z);scene.add(g);return g;
}

// ============ GLB TREES ============
const TREE_URL = 'assets/stylized_pine_tree_tree.glb';
const loadBar = document.getElementById('loading-bar');
let loadedTreeModel = null;
const defaultObjects = []; // {obj, name, id} for selectable default objects
const gltfLoader = new THREE.GLTFLoader();
gltfLoader.load(TREE_URL,
  (gltf) => {
    const treeModel = gltf.scene;
    treeModel.traverse(child => { if (child.isMesh) { child.castShadow=true; child.receiveShadow=true; }});
    loadedTreeModel = treeModel;
    [{x:-4,z:-3,scale:0.02,id:'tree0'},{x:-3,z:3,scale:0.015,id:'tree1'},{x:4,z:3,scale:0.018,id:'tree2'}].forEach(t => {
      const tree = treeModel.clone(); tree.position.set(t.x,0.15,t.z); tree.scale.setScalar(t.scale); scene.add(tree);
      defaultObjects.push({obj:tree, name:'Tree', id:t.id});
    });
    loadBar.style.width='100%';
    setTimeout(()=>document.getElementById('loading').classList.add('done'),300);
  },
  (p)=>{if(p.total)loadBar.style.width=(p.loaded/p.total*100)+'%';},
  ()=>{
    const t0=mkPine(-4,-3,0.02);defaultObjects.push({obj:t0,name:'Pine',id:'tree0'});
    const t1=mkPine(-3,3,0.015);defaultObjects.push({obj:t1,name:'Pine',id:'tree1'});
    const t2=mkRound(4,3,0.018);defaultObjects.push({obj:t2,name:'Round Tree',id:'tree2'});
    loadBar.style.width='100%';setTimeout(()=>document.getElementById('loading').classList.add('done'),300);
  }
);

// Flowers
for(let i=0;i<5;i++){
  const fg=new THREE.Group();
  const st=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.4,4),new THREE.MeshLambertMaterial({color:0x6aaa55}));
  st.position.y=0.2;fg.add(st);
  const cs=[0xf5a0b0,0xf0d060,0xffffff,0xc8a0f0];
  const pt=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),new THREE.MeshLambertMaterial({color:cs[Math.floor(Math.random()*4)]}));
  pt.position.y=0.45;fg.add(pt);
  const a=Math.random()*Math.PI*2,dd=2+Math.random()*3;
  fg.position.set(Math.cos(a)*dd,0,Math.sin(a)*dd);scene.add(fg);
}

// Fence
const fenceM=new THREE.MeshLambertMaterial({color:0xc4a46a});
[[-1,2],[1,2],[3,2],[3,0]].forEach(([x,z])=>{
  const p=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.8,0.15),fenceM);
  p.position.set(x,0.4,z);p.castShadow=true;scene.add(p);
});
const railM=new THREE.MeshLambertMaterial({color:0xb89858});
[[[-1,2],[1,2]],[[1,2],[3,2]],[[3,2],[3,0]]].forEach(([[x1,z1],[x2,z2]])=>{
  const dx=x2-x1,dz=z2-z1,len=Math.sqrt(dx*dx+dz*dz);
  const r=new THREE.Mesh(new THREE.BoxGeometry(len,0.08,0.08),railM);
  r.position.set((x1+x2)/2,0.55,(z1+z2)/2);r.rotation.y=Math.atan2(dz,dx);scene.add(r);
});

// ============ SHEEP CHARACTER ============
function createSheep(name, woolColor) {
  const sheep = new THREE.Group();
  const sb = new THREE.Mesh(new THREE.SphereGeometry(0.55,8,6), new THREE.MeshLambertMaterial({color: woolColor}));
  sb.position.y=0.7; sb.scale.set(1.1,0.9,0.85); sb.castShadow=true; sheep.add(sb);
  sheep.bodyMesh = sb;
  const sh = new THREE.Mesh(new THREE.SphereGeometry(0.3,8,6), new THREE.MeshLambertMaterial({color:0x3d3530}));
  sh.position.set(0,0.9,0.5); sh.castShadow=true; sheep.add(sh);
  [[-0.12,0.95,0.72],[0.12,0.95,0.72]].forEach(p=>{
    const e=new THREE.Mesh(new THREE.SphereGeometry(0.06,6,4),new THREE.MeshLambertMaterial({color:0xffffff}));
    e.position.set(...p); sheep.add(e);
  });
  [[-0.12,0.95,0.77],[0.12,0.95,0.77]].forEach(p=>{
    const e=new THREE.Mesh(new THREE.SphereGeometry(0.035,6,4),new THREE.MeshLambertMaterial({color:0x1a1a1a}));
    e.position.set(...p); sheep.add(e);
  });
  const sheepLegs=[];
  const lg=new THREE.CylinderGeometry(0.07,0.07,0.4,5),lm=new THREE.MeshLambertMaterial({color:0x3d3530});
  [[-0.25,0.2,0.2],[0.25,0.2,0.2],[-0.25,0.2,-0.2],[0.25,0.2,-0.2]].forEach(p=>{
    const l=new THREE.Mesh(lg,lm);l.position.set(...p);l.castShadow=true;sheep.add(l);sheepLegs.push(l);
  });
  sheep.legs = sheepLegs;
  const nc=document.createElement('canvas');nc.width=128;nc.height=32;
  const nx=nc.getContext('2d');
  nx.fillStyle='rgba(45,65,45,0.85)';nx.beginPath();nx.roundRect(0,0,128,32,8);nx.fill();
  nx.fillStyle='#e8f0e4';nx.font='bold 16px sans-serif';nx.textAlign='center';
  nx.fillText(name.toUpperCase(),64,22);
  const nt=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(nc),transparent:true}));
  nt.scale.set(1.5,0.4,1);nt.position.y=1.6;sheep.add(nt);
  const shadow=new THREE.Mesh(new THREE.CircleGeometry(0.5,16),new THREE.MeshBasicMaterial({color:0,transparent:true,opacity:0.12}));
  shadow.rotation.x=-Math.PI/2;shadow.position.y=0.01;
  sheep.shadowMesh=shadow;
  return sheep;
}

let player, playerShadow, legs;
const remotePlayers = {};
let placedObjects = [];
const placedObjectsMap = {};

// ============ BUILD / DEMOLISH ============
let selectedBuildItem = null;
let demolishMode = false;
let selectMode = false;
let selectedObject = null; // {obj, name, id, fbKey (if placed obj)}

function placeTree(x,z){
  let obj;
  if(loadedTreeModel){obj=loadedTreeModel.clone();obj.position.set(x,0.15,z);obj.scale.setScalar(0.02);scene.add(obj);}
  else{obj=mkPine(x,z,0.02);}
  return obj;
}
function placeGrassTuft(x,z){
  const m=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.3,0.15),new THREE.MeshLambertMaterial({color:0x8cc47a}));
  m.position.set(x,0.25,z);m.castShadow=true;scene.add(m);return m;
}
function placeFlower(x,z){
  const fg=new THREE.Group();
  const st=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.4,4),new THREE.MeshLambertMaterial({color:0x6aaa55}));
  st.position.y=0.2;fg.add(st);
  const cs=[0xf5a0b0,0xf0d060,0xffffff,0xc8a0f0];
  const pt=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),new THREE.MeshLambertMaterial({color:cs[Math.floor(Math.random()*4)]}));
  pt.position.y=0.45;fg.add(pt);
  fg.position.set(x,0,z);scene.add(fg);return fg;
}
function placeFencePost(x,z){
  const m=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.8,0.15),new THREE.MeshLambertMaterial({color:0xc4a46a}));
  m.position.set(x,0.4,z);m.castShadow=true;scene.add(m);return m;
}
function placeRock(x,z){
  const g=new THREE.Group();
  const r1=new THREE.Mesh(new THREE.SphereGeometry(0.3,6,4),new THREE.MeshLambertMaterial({color:0x8a8a7a}));
  r1.scale.set(1,0.6,0.9);r1.position.y=0.18;r1.castShadow=true;g.add(r1);
  const r2=new THREE.Mesh(new THREE.SphereGeometry(0.18,5,3),new THREE.MeshLambertMaterial({color:0x9a9a8a}));
  r2.position.set(0.2,0.12,0.15);r2.castShadow=true;g.add(r2);
  g.position.set(x,0,z);scene.add(g);return g;
}
function placeStonePath(x,z){
  const g=new THREE.Group();
  for(let i=0;i<5;i++){
    const s=new THREE.Mesh(new THREE.CylinderGeometry(0.2+Math.random()*0.15,0.2+Math.random()*0.15,0.06,6),
      new THREE.MeshLambertMaterial({color:0xb0aa98}));
    s.position.set((Math.random()-0.5)*1.5,0.16,i*0.7-1.4);s.rotation.y=Math.random()*Math.PI;
    s.receiveShadow=true;g.add(s);
  }
  g.position.set(x,0,z);scene.add(g);return g;
}
function placePond(x,z){
  const g=new THREE.Group();
  const water=new THREE.Mesh(new THREE.CylinderGeometry(1.2,1.3,0.1,16),new THREE.MeshLambertMaterial({color:0x5a9aba,transparent:true,opacity:0.7}));
  water.position.y=0.12;water.receiveShadow=true;g.add(water);
  const edge=new THREE.Mesh(new THREE.TorusGeometry(1.25,0.12,6,16),new THREE.MeshLambertMaterial({color:0x7a8a6a}));
  edge.rotation.x=-Math.PI/2;edge.position.y=0.15;g.add(edge);
  // Lily pads
  for(let i=0;i<3;i++){
    const lp=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,0.02,8),new THREE.MeshLambertMaterial({color:0x4a8a3a}));
    const a=Math.random()*Math.PI*2,r=Math.random()*0.7;
    lp.position.set(Math.cos(a)*r,0.18,Math.sin(a)*r);g.add(lp);
  }
  g.position.set(x,0,z);scene.add(g);return g;
}

const buildFactories = { tree:placeTree, grass:placeGrassTuft, flower:placeFlower, fence:placeFencePost, rock:placeRock, path:placeStonePath, pond:placePond };

function updateBuildUI(){
  document.querySelectorAll('.build-slot').forEach(s=>s.classList.toggle('selected',s.dataset.item===selectedBuildItem));
  document.getElementById('placement-hint').classList.toggle('visible',selectedBuildItem!==null);
  document.getElementById('demolish-hint').style.display=demolishMode?'block':'none';
  document.getElementById('demolish-btn').classList.toggle('active',demolishMode);
  document.getElementById('select-hint').style.display=selectMode?'block':'none';
  const selBtn = document.getElementById('select-btn');
  selBtn.classList.toggle('active-select',selectMode);
  selBtn.classList.remove('active');
}
function cancelBuild(){selectedBuildItem=null;demolishMode=false;selectMode=false;deselectObject();updateBuildUI();}
function toggleDemolish(){
  if(demolishMode){cancelBuild();return;}
  selectedBuildItem=null;selectMode=false;deselectObject();buildPanel.classList.remove('open');demolishMode=true;updateBuildUI();
}
function toggleSelect(){
  if(selectMode){cancelBuild();return;}
  selectedBuildItem=null;demolishMode=false;buildPanel.classList.remove('open');selectMode=true;updateBuildUI();
}

const buildPanel=document.getElementById('build-panel');
document.getElementById('build-btn').addEventListener('click',()=>{
  demolishMode=false;buildPanel.classList.toggle('open');
  if(!buildPanel.classList.contains('open'))cancelBuild();updateBuildUI();
});
document.getElementById('demolish-btn').addEventListener('click',toggleDemolish);
document.getElementById('select-btn').addEventListener('click',toggleSelect);
document.getElementById('build-close').addEventListener('click',()=>{buildPanel.classList.remove('open');cancelBuild();});
document.querySelectorAll('.build-slot').forEach(slot=>{
  slot.addEventListener('click',()=>{selectedBuildItem=slot.dataset.item;demolishMode=false;updateBuildUI();buildPanel.classList.remove('open');});
});
addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='b'||e.key==='B'){demolishMode=false;buildPanel.classList.toggle('open');if(!buildPanel.classList.contains('open'))cancelBuild();updateBuildUI();}
  if(e.key==='x'||e.key==='X'){toggleDemolish();}
  if(e.key==='v'||e.key==='V'){toggleSelect();}
  if(e.key==='Escape'){buildPanel.classList.remove('open');cancelBuild();document.getElementById('admin-panel').classList.remove('open');}
});
renderer.domElement.addEventListener('contextmenu',e=>{e.preventDefault();cancelBuild();});

// ============ MOVEMENT ============
let targetPos=new THREE.Vector3(0,0,2),isMoving=false;
const ray=new THREE.Raycaster(),mss=new THREE.Vector2();

renderer.domElement.addEventListener('click',e=>{
  if(isDrag)return;
  mss.x=(e.clientX/innerWidth)*2-1;mss.y=-(e.clientY/innerHeight)*2+1;
  ray.setFromCamera(mss,camera);

  // Select mode
  if(selectMode){
    // Collect all selectable meshes: default objects + placed objects
    let allSelectables = [];
    defaultObjects.forEach(entry => {
      if(entry.obj.isMesh) allSelectables.push({mesh:entry.obj,root:entry.obj,name:entry.name,id:entry.id,fbKey:null});
      else entry.obj.traverse(child=>{if(child.isMesh)allSelectables.push({mesh:child,root:entry.obj,name:entry.name,id:entry.id,fbKey:null});});
    });
    placedObjects.forEach(obj => {
      let fbKey=null;
      for(const[k,v]of Object.entries(placedObjectsMap)){if(v===obj){fbKey=k;break;}}
      if(obj.isMesh) allSelectables.push({mesh:obj,root:obj,name:'Placed',id:fbKey,fbKey});
      else obj.traverse(child=>{if(child.isMesh)allSelectables.push({mesh:child,root:obj,name:'Placed',id:fbKey,fbKey});});
    });
    const hits=ray.intersectObjects(allSelectables.map(m=>m.mesh),false);
    if(hits.length){
      const entry=allSelectables.find(m=>m.mesh===hits[0].object);
      if(entry) selectObject(entry.root,entry.name,entry.id,entry.fbKey,e.clientX,e.clientY);
    }
    return;
  }

  // Demolish mode
    let allMeshes=[];
    placedObjects.forEach(obj=>{
      if(obj.isMesh){allMeshes.push({mesh:obj,root:obj});}
      else{obj.traverse(child=>{if(child.isMesh)allMeshes.push({mesh:child,root:obj});});}
    });
    const hits=ray.intersectObjects(allMeshes.map(m=>m.mesh),false);
    if(hits.length){
      const entry=allMeshes.find(m=>m.mesh===hits[0].object);
      if(entry){
        let fbKey=null;
        for(const[key,obj]of Object.entries(placedObjectsMap)){if(obj===entry.root){fbKey=key;break;}}
        if(fbKey)db.ref('objects/'+fbKey).remove();
      }
    }
    return;
  }
  const h=ray.intersectObject(groundPlane);
  if(h.length){
    if(selectedBuildItem){
      const pt=h[0].point;
      db.ref('objects').push({type:selectedBuildItem,x:pt.x,z:pt.z,placedBy:localPlayerId});
      cancelBuild();return;
    }
    targetPos.copy(h[0].point);targetPos.y=0;isMoving=true;
    const ind=document.getElementById('click-indicator');
    ind.style.left=e.clientX+'px';ind.style.top=e.clientY+'px';
    ind.classList.remove('active');void ind.offsetWidth;ind.classList.add('active');
  }
});

// ============ CAMERA ============
let isDrag=false,pmx=0,pmy=0,camA=Math.PI/4,camP=0.5,camD=14;
renderer.domElement.addEventListener('mousedown',e=>{isDrag=false;pmx=e.clientX;pmy=e.clientY;});
renderer.domElement.addEventListener('mousemove',e=>{
  if(e.buttons!==1)return;
  const dx=e.clientX-pmx,dy=e.clientY-pmy;
  if(Math.abs(dx)>3||Math.abs(dy)>3)isDrag=true;
  camA-=dx*0.005;camP=Math.max(0.2,Math.min(1.2,camP+dy*0.005));
  pmx=e.clientX;pmy=e.clientY;
});
renderer.domElement.addEventListener('wheel',e=>{camD=Math.max(6,Math.min(30,camD+e.deltaY*0.02));});
renderer.domElement.addEventListener('touchstart',e=>{if(e.touches.length===1){pmx=e.touches[0].clientX;pmy=e.touches[0].clientY;isDrag=false;}});
renderer.domElement.addEventListener('touchmove',e=>{
  if(e.touches.length===1){
    const dx=e.touches[0].clientX-pmx,dy=e.touches[0].clientY-pmy;
    if(Math.abs(dx)>3||Math.abs(dy)>3)isDrag=true;
    camA-=dx*0.005;camP=Math.max(0.2,Math.min(1.2,camP+dy*0.005));
    pmx=e.touches[0].clientX;pmy=e.touches[0].clientY;
  }
  e.preventDefault();
},{passive:false});

// ============ CHAT ============
const ci=document.getElementById('chat-input'),cm=document.getElementById('chat-messages');
function sendMsg(){
  const m=ci.value.trim();if(!m)return;
  db.ref('chat').push({name:localPlayerName,text:m,time:Date.now()});
  ci.value='';
}
document.getElementById('chat-send').addEventListener('click',sendMsg);
ci.addEventListener('keydown',e=>{if(e.key==='Enter')sendMsg();});
function escapeHTML(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ============ ADMIN PANEL ============
const adminPanel = document.getElementById('admin-panel');
document.getElementById('admin-btn').addEventListener('click', () => adminPanel.classList.toggle('open'));
document.getElementById('admin-panel-close').addEventListener('click', () => adminPanel.classList.remove('open'));

// Map size slider
const mapSizeSlider = document.getElementById('admin-map-size');
mapSizeSlider.addEventListener('input', () => {
  document.getElementById('admin-map-size-val').textContent = mapSizeSlider.value;
  buildGround(parseFloat(mapSizeSlider.value));
});

// House position/scale
const houseXSlider = document.getElementById('admin-house-x');
const houseZSlider = document.getElementById('admin-house-z');
const houseScaleSlider = document.getElementById('admin-house-scale');
houseXSlider.addEventListener('input', () => {
  document.getElementById('admin-house-x-val').textContent = houseXSlider.value;
  if(farmhouse && farmhouseVisible) farmhouse.position.x = parseFloat(houseXSlider.value);
});
houseZSlider.addEventListener('input', () => {
  document.getElementById('admin-house-z-val').textContent = houseZSlider.value;
  if(farmhouse && farmhouseVisible) farmhouse.position.z = parseFloat(houseZSlider.value);
});
houseScaleSlider.addEventListener('input', () => {
  document.getElementById('admin-house-scale-val').textContent = parseFloat(houseScaleSlider.value).toFixed(1);
  if(farmhouse && farmhouseVisible) farmhouse.scale.setScalar(parseFloat(houseScaleSlider.value));
});
document.getElementById('admin-house-toggle').addEventListener('click', () => {
  if(farmhouseVisible) {
    scene.remove(farmhouse);
    farmhouseVisible = false;
    document.getElementById('admin-house-toggle').textContent = 'Show Farmhouse';
  } else {
    scene.add(farmhouse);
    farmhouseVisible = true;
    document.getElementById('admin-house-toggle').textContent = 'Hide Farmhouse';
  }
});

// Sky/fog colors
document.getElementById('admin-sky-color').addEventListener('input', e => {
  const c = new THREE.Color(e.target.value);
  scene.background = c;
  scene.fog.color = c;
  document.body.style.background = e.target.value;
});
document.getElementById('admin-ground-color').addEventListener('input', e => {
  if(gtMesh) gtMesh.material.color.set(e.target.value);
});
document.getElementById('admin-light-color').addEventListener('input', e => {
  dl.color.set(e.target.value);
});
document.getElementById('admin-fog').addEventListener('input', e => {
  scene.fog.density = parseFloat(e.target.value);
  document.getElementById('admin-fog-val').textContent = e.target.value;
});

// Sky presets
const skyPresets = {
  default:  { sky:'#d4e4d0', ground:'#a8d89a', light:'#fff0d4', fog:0.012 },
  sunset:   { sky:'#f0b878', ground:'#c8a870', light:'#ff9944', fog:0.015 },
  night:    { sky:'#1a2030', ground:'#2a3a2a', light:'#4466aa', fog:0.02 },
  winter:   { sky:'#e0e8f0', ground:'#d8dce0', light:'#e8e8ff', fog:0.01 },
  cherry:   { sky:'#f5d0d8', ground:'#c8b8a0', light:'#ffe0e0', fog:0.01 },
  autumn:   { sky:'#d8c0a0', ground:'#b09060', light:'#f0c878', fog:0.014 }
};
document.querySelectorAll('.admin-preset').forEach(btn => {
  btn.addEventListener('click', () => {
    const p = skyPresets[btn.dataset.preset];
    if(!p) return;
    scene.background = new THREE.Color(p.sky);
    scene.fog.color = new THREE.Color(p.sky);
    scene.fog.density = p.fog;
    document.body.style.background = p.sky;
    if(gtMesh) gtMesh.material.color.set(p.ground);
    dl.color.set(p.light);
    document.getElementById('admin-sky-color').value = p.sky;
    document.getElementById('admin-ground-color').value = p.ground;
    document.getElementById('admin-light-color').value = p.light;
    document.getElementById('admin-fog').value = p.fog;
    document.getElementById('admin-fog-val').textContent = p.fog;
  });
});

// Quick decorations
document.getElementById('admin-add-rocks').addEventListener('click', () => {
  for(let i=0;i<5;i++){
    const half=mapSize/2-1;
    const x=(Math.random()-0.5)*half*2, z=(Math.random()-0.5)*half*2;
    db.ref('objects').push({type:'rock',x,z,placedBy:localPlayerId});
  }
});
document.getElementById('admin-add-path').addEventListener('click', () => {
  db.ref('objects').push({type:'path',x:0,z:2,placedBy:localPlayerId});
});
document.getElementById('admin-add-pond').addEventListener('click', () => {
  const half=mapSize/2-2;
  const x=(Math.random()-0.5)*half*2, z=(Math.random()-0.5)*half*2;
  db.ref('objects').push({type:'pond',x,z,placedBy:localPlayerId});
});
document.getElementById('admin-add-flowers').addEventListener('click', () => {
  for(let i=0;i<8;i++){
    const half=mapSize/2-1;
    const x=(Math.random()-0.5)*half*2, z=(Math.random()-0.5)*half*2;
    db.ref('objects').push({type:'flower',x,z,placedBy:localPlayerId});
  }
});
document.getElementById('admin-clear-all').addEventListener('click', () => {
  if(confirm('Remove ALL placed objects?')) db.ref('objects').remove();
});

// Save map settings to Firebase
document.getElementById('admin-save').addEventListener('click', () => {
  db.ref('mapSettings').set({
    mapSize: parseFloat(mapSizeSlider.value),
    houseX: parseFloat(houseXSlider.value),
    houseZ: parseFloat(houseZSlider.value),
    houseScale: parseFloat(houseScaleSlider.value),
    houseVisible: farmhouseVisible,
    skyColor: document.getElementById('admin-sky-color').value,
    groundColor: document.getElementById('admin-ground-color').value,
    lightColor: document.getElementById('admin-light-color').value,
    fogDensity: parseFloat(document.getElementById('admin-fog').value)
  });
  // Flash the button
  const btn = document.getElementById('admin-save');
  btn.textContent = '‚úÖ Saved!';
  setTimeout(() => btn.textContent = 'Save Map Settings to Server', 1500);
});

// Load map settings from Firebase
function loadMapSettings(data) {
  if(!data) return;
  if(data.mapSize) { buildGround(data.mapSize); mapSizeSlider.value=data.mapSize; document.getElementById('admin-map-size-val').textContent=data.mapSize; }
  if(data.houseX!==undefined) { houseXSlider.value=data.houseX; document.getElementById('admin-house-x-val').textContent=data.houseX; }
  if(data.houseZ!==undefined) { houseZSlider.value=data.houseZ; document.getElementById('admin-house-z-val').textContent=data.houseZ; }
  if(data.houseScale) { houseScaleSlider.value=data.houseScale; document.getElementById('admin-house-scale-val').textContent=parseFloat(data.houseScale).toFixed(1); }
  buildHouse(data.houseX||1, data.houseZ||-1, data.houseScale||1);
  if(data.houseVisible===false) { scene.remove(farmhouse); farmhouseVisible=false; document.getElementById('admin-house-toggle').textContent='Show Farmhouse'; }
  if(data.skyColor) {
    scene.background=new THREE.Color(data.skyColor); scene.fog.color=new THREE.Color(data.skyColor);
    document.body.style.background=data.skyColor; document.getElementById('admin-sky-color').value=data.skyColor;
  }
  if(data.groundColor) { if(gtMesh)gtMesh.material.color.set(data.groundColor); document.getElementById('admin-ground-color').value=data.groundColor; }
  if(data.lightColor) { dl.color.set(data.lightColor); document.getElementById('admin-light-color').value=data.lightColor; }
  if(data.fogDensity!==undefined) { scene.fog.density=data.fogDensity; document.getElementById('admin-fog').value=data.fogDensity; document.getElementById('admin-fog-val').textContent=data.fogDensity; }
}

// ============ SELECT & EDIT SYSTEM ============
const floatEdit = document.getElementById('float-edit');

function selectObject(obj, name, id, fbKey, screenX, screenY) {
  deselectObject();
  selectedObject = {obj, name, id, fbKey};

  // Position floating panel near click
  const panelX = Math.min(screenX + 20, innerWidth - 290);
  const panelY = Math.min(screenY - 40, innerHeight - 320);
  floatEdit.style.left = panelX + 'px';
  floatEdit.style.top = Math.max(10, panelY) + 'px';

  // Set slider values from object
  const s = obj.scale.x;
  document.getElementById('fedit-scale').value = s;
  document.getElementById('fedit-scale-val').textContent = s.toFixed(3);
  // Adjust scale slider range based on current scale
  const scaleSlider = document.getElementById('fedit-scale');
  if (s > 1) { scaleSlider.max = Math.max(5, s * 2); } else { scaleSlider.max = Math.max(0.5, s * 10); }
  scaleSlider.min = Math.max(0.001, s * 0.1);
  scaleSlider.step = s > 0.1 ? 0.01 : 0.001;

  document.getElementById('fedit-x').value = obj.position.x;
  document.getElementById('fedit-x-val').textContent = obj.position.x.toFixed(2);
  document.getElementById('fedit-y').value = obj.position.y;
  document.getElementById('fedit-y-val').textContent = obj.position.y.toFixed(2);
  document.getElementById('fedit-z').value = obj.position.z;
  document.getElementById('fedit-z-val').textContent = obj.position.z.toFixed(2);
  document.getElementById('fedit-ry').value = obj.rotation.y;
  document.getElementById('fedit-ry-val').textContent = obj.rotation.y.toFixed(2);

  document.getElementById('float-edit-name').textContent = '‚úã ' + name + (id ? ' (' + id + ')' : '');
  floatEdit.classList.add('open');
}

function deselectObject() {
  selectedObject = null;
  floatEdit.classList.remove('open');
}

document.getElementById('float-edit-close').addEventListener('click', deselectObject);

// Float edit sliders
['scale','x','y','z','ry'].forEach(key => {
  const slider = document.getElementById('fedit-' + key);
  const valSpan = document.getElementById('fedit-' + key + '-val');
  slider.addEventListener('input', () => {
    if (!selectedObject) return;
    const v = parseFloat(slider.value);
    valSpan.textContent = key === 'scale' ? v.toFixed(3) : v.toFixed(2);
    const obj = selectedObject.obj;
    if (key === 'scale') obj.scale.setScalar(v);
    else if (key === 'x') obj.position.x = v;
    else if (key === 'y') obj.position.y = v;
    else if (key === 'z') obj.position.z = v;
    else if (key === 'ry') obj.rotation.y = v;
  });
});

// Save edits to Firebase
document.getElementById('fedit-save').addEventListener('click', () => {
  if (!selectedObject) return;
  const obj = selectedObject.obj;
  const data = {
    sx: obj.scale.x, sy: obj.scale.y, sz: obj.scale.z,
    px: obj.position.x, py: obj.position.y, pz: obj.position.z,
    ry: obj.rotation.y
  };

  if (selectedObject.fbKey) {
    // Placed object ‚Äî update in objects/
    db.ref('objects/' + selectedObject.fbKey).update({
      px: data.px, py: data.py, pz: data.pz,
      sx: data.sx, ry: data.ry
    });
  } else if (selectedObject.id) {
    // Default object ‚Äî save in defaultEdits/
    db.ref('defaultEdits/' + selectedObject.id).set(data);
  }

  const btn = document.getElementById('fedit-save');
  btn.textContent = '‚úÖ Saved!';
  setTimeout(() => btn.textContent = 'üíæ Save to Server', 1500);
});

// Copy values
document.getElementById('fedit-copy').addEventListener('click', () => {
  if (!selectedObject) return;
  const obj = selectedObject.obj;
  const code = `// ${selectedObject.name} (${selectedObject.id || 'placed'})
model.scale.setScalar(${obj.scale.x.toFixed(4)});
model.position.set(${obj.position.x.toFixed(2)}, ${obj.position.y.toFixed(2)}, ${obj.position.z.toFixed(2)});
model.rotation.y = ${obj.rotation.y.toFixed(2)};`;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('fedit-copy');
    btn.textContent = '‚úÖ Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy Values', 1500);
  }).catch(() => {});
});

// ============ ASSET EDITOR ============
let previewAsset = null;
let previewAssetPath = '';
const assetEditorLoader = new THREE.GLTFLoader();

// Show/hide custom path input
document.getElementById('asset-select').addEventListener('change', e => {
  document.getElementById('asset-custom-input').style.display = e.target.value === 'custom' ? 'block' : 'none';
});

// Load custom GLB
document.getElementById('asset-custom-load').addEventListener('click', () => {
  const filename = document.getElementById('asset-custom-path').value.trim();
  if (!filename) return;
  previewAssetPath = 'assets/' + filename;
  loadPreviewAsset(previewAssetPath);
});

// Spawn asset
document.getElementById('asset-spawn').addEventListener('click', () => {
  const sel = document.getElementById('asset-select').value;
  if (sel === 'tree') {
    previewAssetPath = TREE_URL;
    loadPreviewAsset(previewAssetPath);
  } else if (sel === 'custom') {
    const filename = document.getElementById('asset-custom-path').value.trim();
    if (!filename) { alert('Enter a GLB filename first!'); return; }
    previewAssetPath = 'assets/' + filename;
    loadPreviewAsset(previewAssetPath);
  }
});

function loadPreviewAsset(url) {
  // Remove old preview
  if (previewAsset) { scene.remove(previewAsset); previewAsset = null; }

  const spawnBtn = document.getElementById('asset-spawn');
  spawnBtn.textContent = '‚è≥ Loading...';
  spawnBtn.disabled = true;

  assetEditorLoader.load(url,
    (gltf) => {
      previewAsset = gltf.scene;
      previewAsset.traverse(child => { if (child.isMesh) { child.castShadow = true; child.receiveShadow = true; }});

      // Set initial values from sliders
      const s = parseFloat(document.getElementById('asset-scale').value);
      previewAsset.scale.setScalar(s);
      previewAsset.position.set(
        parseFloat(document.getElementById('asset-pos-x').value),
        parseFloat(document.getElementById('asset-pos-y').value),
        parseFloat(document.getElementById('asset-pos-z').value)
      );
      previewAsset.rotation.y = parseFloat(document.getElementById('asset-rot-y').value);
      scene.add(previewAsset);

      // Show editor controls
      document.getElementById('asset-editor-controls').style.display = 'block';
      spawnBtn.textContent = 'Spawn Asset on Map';
      spawnBtn.disabled = false;
      console.log('Preview asset loaded:', url);
    },
    null,
    (err) => {
      alert('Failed to load GLB! Make sure the file is in your assets/ folder on GitHub.\n\nPath tried: ' + url);
      spawnBtn.textContent = 'Spawn Asset on Map';
      spawnBtn.disabled = false;
      console.error('Asset load error:', err);
    }
  );
}

// Live slider updates
['scale','pos-x','pos-y','pos-z','rot-y'].forEach(key => {
  const slider = document.getElementById('asset-' + key);
  const valSpan = document.getElementById('asset-' + key + '-val');
  slider.addEventListener('input', () => {
    const v = parseFloat(slider.value);
    if (key === 'scale') {
      valSpan.textContent = v.toFixed(3);
      if (previewAsset) previewAsset.scale.setScalar(v);
    } else if (key === 'pos-x') {
      valSpan.textContent = v.toFixed(2);
      if (previewAsset) previewAsset.position.x = v;
    } else if (key === 'pos-y') {
      valSpan.textContent = v.toFixed(2);
      if (previewAsset) previewAsset.position.y = v;
    } else if (key === 'pos-z') {
      valSpan.textContent = v.toFixed(2);
      if (previewAsset) previewAsset.position.z = v;
    } else if (key === 'rot-y') {
      valSpan.textContent = v.toFixed(1);
      if (previewAsset) previewAsset.rotation.y = v;
    }
  });
});

// Copy values as code
document.getElementById('asset-copy-values').addEventListener('click', () => {
  if (!previewAsset) return;
  const code =
`// Asset: ${previewAssetPath}
scale: ${previewAsset.scale.x.toFixed(4)}
position: { x: ${previewAsset.position.x.toFixed(2)}, y: ${previewAsset.position.y.toFixed(2)}, z: ${previewAsset.position.z.toFixed(2)} }
rotation.y: ${previewAsset.rotation.y.toFixed(2)}

// Three.js code:
model.scale.setScalar(${previewAsset.scale.x.toFixed(4)});
model.position.set(${previewAsset.position.x.toFixed(2)}, ${previewAsset.position.y.toFixed(2)}, ${previewAsset.position.z.toFixed(2)});
model.rotation.y = ${previewAsset.rotation.y.toFixed(2)};`;

  const codeBox = document.getElementById('asset-code-output');
  codeBox.textContent = code;
  codeBox.classList.add('visible');

  // Also copy to clipboard
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('asset-copy-values');
    btn.textContent = '‚úÖ Copied to clipboard!';
    setTimeout(() => btn.textContent = 'üìã Copy Values as Code', 2000);
  }).catch(() => {
    // Clipboard might not work, that's ok - code box is visible
  });
});

// Remove preview
document.getElementById('asset-remove').addEventListener('click', () => {
  if (previewAsset) { scene.remove(previewAsset); previewAsset = null; }
  document.getElementById('asset-editor-controls').style.display = 'none';
  document.getElementById('asset-code-output').classList.remove('visible');
});

// ============ INIT GAME ============
function initGame() {
  player = createSheep(localPlayerName, 0xf5f0e8);
  player.position.set(0, 0, 2);
  scene.add(player);
  legs = player.legs;
  playerShadow = player.shadowMesh;
  playerShadow.position.set(0, 0.16, 2);
  scene.add(playerShadow);

  const playerRef = db.ref('players/' + localPlayerId);
  playerRef.set({ name: localPlayerName, x: 0, z: 2, rot: 0 });
  playerRef.onDisconnect().remove();

  // Load saved map settings
  db.ref('mapSettings').once('value', snap => loadMapSettings(snap.val()));
  // Listen for live map setting changes
  db.ref('mapSettings').on('value', snap => loadMapSettings(snap.val()));

  db.ref('players').on('child_added', snap => {
    const id=snap.key; if(id===localPlayerId)return;
    const data=snap.val();
    const colors=[0xd4c4b0,0xc4d4e0,0xe0c4d4,0xd4e0c4,0xe0d4b0];
    const ci2=Math.abs(id.split('').reduce((a,c)=>a+c.charCodeAt(0),0))%colors.length;
    const remote=createSheep(data.name,colors[ci2]);
    remote.position.set(data.x,0,data.z);scene.add(remote);
    const rShadow=remote.shadowMesh;rShadow.position.set(data.x,0.16,data.z);scene.add(rShadow);
    remotePlayers[id]={group:remote,shadow:rShadow,targetX:data.x,targetZ:data.z,targetRot:data.rot||0,legs:remote.legs,bodyMesh:remote.bodyMesh};
    updatePlayerCount();
  });
  db.ref('players').on('child_changed', snap => {
    const id=snap.key;if(id===localPlayerId)return;const data=snap.val();
    if(remotePlayers[id]){remotePlayers[id].targetX=data.x;remotePlayers[id].targetZ=data.z;remotePlayers[id].targetRot=data.rot||0;}
  });
  db.ref('players').on('child_removed', snap => {
    const id=snap.key;
    if(remotePlayers[id]){scene.remove(remotePlayers[id].group);scene.remove(remotePlayers[id].shadow);delete remotePlayers[id];updatePlayerCount();}
  });

  db.ref('chat').orderByChild('time').limitToLast(50).on('child_added', snap => {
    const data=snap.val();const d=document.createElement('div');d.style.marginTop='6px';
    const color=data.name===localPlayerName?'#7ecd6a':'#6ab8e0';
    d.innerHTML='<span style="color:'+color+';font-weight:600;">'+escapeHTML(data.name)+':</span> '+escapeHTML(data.text);
    cm.appendChild(d);cm.scrollTop=cm.scrollHeight;
  });

  db.ref('objects').on('child_added', snap => {
    const data=snap.val(),key=snap.key;
    if(buildFactories[data.type]){
      const obj=buildFactories[data.type](data.x,data.z);
      // Apply saved edits if any
      if(data.sx) obj.scale.setScalar(data.sx);
      if(data.px!==undefined) obj.position.x=data.px;
      if(data.py!==undefined) obj.position.y=data.py;
      if(data.pz!==undefined) obj.position.z=data.pz;
      if(data.ry!==undefined) obj.rotation.y=data.ry;
      placedObjects.push(obj);placedObjectsMap[key]=obj;
    }
  });
  db.ref('objects').on('child_changed', snap => {
    const data=snap.val(),key=snap.key;
    if(placedObjectsMap[key]){
      const obj=placedObjectsMap[key];
      if(data.sx) obj.scale.setScalar(data.sx);
      if(data.px!==undefined) obj.position.x=data.px;
      if(data.py!==undefined) obj.position.y=data.py;
      if(data.pz!==undefined) obj.position.z=data.pz;
      if(data.ry!==undefined) obj.rotation.y=data.ry;
    }
  });
  db.ref('objects').on('child_removed', snap => {
    const key=snap.key;
    if(placedObjectsMap[key]){scene.remove(placedObjectsMap[key]);const idx=placedObjects.indexOf(placedObjectsMap[key]);if(idx>-1)placedObjects.splice(idx,1);delete placedObjectsMap[key];}
  });

  // Listen for default object edits (trees, farmhouse)
  db.ref('defaultEdits').on('value', snap => {
    const edits = snap.val();
    if(!edits) return;
    defaultObjects.forEach(entry => {
      const edit = edits[entry.id];
      if(edit){
        if(edit.sx) entry.obj.scale.set(edit.sx, edit.sy||edit.sx, edit.sz||edit.sx);
        if(edit.px!==undefined) entry.obj.position.x=edit.px;
        if(edit.py!==undefined) entry.obj.position.y=edit.py;
        if(edit.pz!==undefined) entry.obj.position.z=edit.pz;
        if(edit.ry!==undefined) entry.obj.rotation.y=edit.ry;
      }
    });
  });

  animate();
}

function updatePlayerCount(){
  const count=1+Object.keys(remotePlayers).length;
  document.getElementById('player-count').textContent=count+(count===1?' Player':' Players');
}

let lastSyncTime=0;
function syncPosition(){
  const now=Date.now();if(now-lastSyncTime<100)return;lastSyncTime=now;
  db.ref('players/'+localPlayerId).update({x:player.position.x,z:player.position.z,rot:player.rotation.y});
}

let t=0;
function animate(){
  requestAnimationFrame(animate);t+=0.016;
  if(isMoving){
    const dx=targetPos.x-player.position.x,dz=targetPos.z-player.position.z;
    if(Math.sqrt(dx*dx+dz*dz)>0.1){
      player.position.x+=dx*0.06;player.position.z+=dz*0.06;
      player.rotation.y=Math.atan2(dx,dz);
      player.position.y=Math.abs(Math.sin(t*8))*0.08;
      legs.forEach((l,i)=>l.rotation.x=Math.sin(t*10+i*Math.PI)*0.3);
      syncPosition();
    }else{isMoving=false;player.position.y=0;legs.forEach(l=>l.rotation.x=0);syncPosition();}
  }else{if(player)player.bodyMesh.scale.y=0.9+Math.sin(t*2)*0.02;}
  if(playerShadow){playerShadow.position.x=player.position.x;playerShadow.position.z=player.position.z;}

  for(const id in remotePlayers){
    const rp=remotePlayers[id],g=rp.group;
    const dx=rp.targetX-g.position.x,dz=rp.targetZ-g.position.z;
    if(Math.sqrt(dx*dx+dz*dz)>0.05){
      g.position.x+=dx*0.08;g.position.z+=dz*0.08;
      g.position.y=Math.abs(Math.sin(t*8))*0.08;
      rp.legs.forEach((l,i)=>l.rotation.x=Math.sin(t*10+i*Math.PI)*0.3);
    }else{g.position.y=0;rp.legs.forEach(l=>l.rotation.x=0);rp.bodyMesh.scale.y=0.9+Math.sin(t*2)*0.02;}
    g.rotation.y+=(rp.targetRot-g.rotation.y)*0.1;
    rp.shadow.position.x=g.position.x;rp.shadow.position.z=g.position.z;
  }

  if(player){
    const cx=player.position.x+Math.sin(camA)*camD*Math.cos(camP);
    const cy=Math.sin(camP)*camD;
    const cz=player.position.z+Math.cos(camA)*camD*Math.cos(camP);
    camera.position.lerp(new THREE.Vector3(cx,cy,cz),0.05);
    camera.lookAt(new THREE.Vector3(player.position.x,1,player.position.z));
  }
  renderer.render(scene,camera);
}

addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
